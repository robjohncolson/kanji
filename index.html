<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>漢字の道 — Kanji Journey to Japan</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        :root {
            --ink: #1a1a1a;
            --paper: #f7f5f0;
            --washi: #faf8f3;
            --vermillion: #d73b3e;
            --gold: #c9a227;
            --gold-light: rgba(201, 162, 39, 0.2);
            --stone: #6b6b6b;
            --mist: #e8e4dc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--paper);
            color: var(--ink);
            min-height: 100vh;
        }

        /* Lock scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
            overscroll-behavior: none;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--mist);
        }

        h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: 0.1em;
        }

        .flight-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--stone);
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 120px;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'Noto Serif JP', serif;
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-value.highlight { color: var(--vermillion); }
        .stat-value.gold { color: var(--gold); }

        .stat-label {
            font-size: 0.7rem;
            color: var(--stone);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Progress Bar */
        .progress-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 10px;
            background: var(--mist);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--vermillion), var(--gold));
            transition: width 0.3s ease;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--vermillion);
            color: white;
        }

        .btn-primary:hover { background: #c13033; }
        .btn-primary:disabled {
            background: var(--mist);
            color: var(--stone);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--mist);
            color: var(--stone);
        }

        .btn-secondary:hover {
            border-color: var(--ink);
            color: var(--ink);
        }

        .mode-toggle {
            display: flex;
            background: var(--paper);
            border: 1px solid var(--mist);
            border-radius: 4px;
            overflow: hidden;
        }

        .mode-btn {
            padding: 0.5rem 0.8rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s;
            color: var(--stone);
        }

        .mode-btn.active {
            background: var(--ink);
            color: var(--paper);
        }

        .selection-count {
            font-size: 0.85rem;
            color: var(--stone);
            margin-left: auto;
        }

        .selection-count strong {
            color: var(--vermillion);
            font-size: 1.1rem;
        }

        /* Grade Sections */
        .grade-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            margin-bottom: 0.5rem;
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .grade-header:hover {
            background: rgba(0,0,0,0.02);
        }

        .grade-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .grade-progress {
            font-size: 0.8rem;
            color: var(--stone);
            background: var(--paper);
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
        }

        .grade-progress .learned-count {
            color: var(--gold);
            font-weight: 600;
        }

        .grade-arrow {
            font-size: 0.8rem;
            color: var(--stone);
            transition: transform 0.2s ease;
        }

        .grade-section.expanded .grade-arrow {
            transform: rotate(180deg);
        }

        .grade-content {
            display: none;
            padding: 0 1rem 1rem;
        }

        .grade-section.expanded .grade-content {
            display: block;
        }

        /* Kanji Grid */
        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
            gap: 4px;
        }

        .kanji-char {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--paper);
            border: 1px solid var(--mist);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .kanji-char:hover {
            border-color: var(--vermillion);
            transform: scale(1.1);
            z-index: 1;
        }

        .kanji-char.learned {
            background: var(--gold-light);
            border-color: var(--gold);
            color: #8a7000;
        }

        .kanji-char.learned::after {
            content: '✓';
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.5rem;
            color: var(--gold);
        }

        /* History */
        .history-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .history-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 1rem;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--mist);
            font-size: 0.85rem;
        }

        .history-item:last-child { border-bottom: none; }

        .history-kanji {
            font-size: 1rem;
            letter-spacing: 0.1em;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-meta {
            text-align: right;
            color: var(--stone);
        }

        .history-count {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--stone);
        }

        .empty-state .kanji {
            font-family: 'Noto Serif JP', serif;
            font-size: 3rem;
            color: var(--mist);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--paper);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 380px;
            position: relative;
            border: 1px solid var(--mist);
        }

        .modal-header {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: var(--ink);
        }

        .modal-header .target-char {
            font-size: 2rem;
            color: var(--vermillion);
        }

        .writer-container {
            width: 280px;
            height: 280px;
            margin: 0 auto 1.5rem;
            border: 1px solid var(--stone);
            background: white;
            position: relative;
            touch-action: none; /* Prevent scroll/zoom while drawing */
        }

        /* 4x4 Grid overlay */
        .writer-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(var(--mist) 1px, transparent 1px),
                linear-gradient(90deg, var(--mist) 1px, transparent 1px);
            background-size: 70px 70px;
            pointer-events: none;
            z-index: 1;
        }

        /* Cross guidelines */
        .writer-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(var(--mist) 1px, transparent 1px) 0 139px / 100% 2px no-repeat,
                linear-gradient(90deg, var(--mist) 1px, transparent 1px) 139px 0 / 2px 100% no-repeat;
            pointer-events: none;
            z-index: 1;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--stone);
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--ink);
        }

        .modal-status {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--stone);
            min-height: 1.2em;
        }

        .modal-status.success {
            color: var(--gold);
            font-weight: 600;
        }

        .modal-status.error {
            color: var(--vermillion);
        }

        /* Share Button */
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: transparent;
            border: 1px solid var(--mist);
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            margin-top: 0.75rem;
            color: var(--stone);
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s ease;
        }

        .share-btn:hover {
            border-color: var(--vermillion);
            color: var(--vermillion);
        }

        /* Share Modal */
        .share-modal-content {
            text-align: center;
        }

        .share-modal-content h3 {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .qr-container {
            background: white;
            padding: 1rem;
            display: inline-block;
            margin-bottom: 1rem;
            border: 1px solid var(--mist);
        }

        .share-url {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-url input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--mist);
            background: var(--paper);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.85rem;
            color: var(--ink);
        }

        .share-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .copy-feedback {
            font-size: 0.8rem;
            color: var(--gold);
            min-height: 1.2em;
            margin-top: 0.5rem;
        }

        /* Streak Badge */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: var(--gold-light);
            border: 1px solid var(--gold);
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            color: var(--gold);
            margin-left: 0.5rem;
        }

        .streak-badge.inactive {
            background: var(--mist);
            border-color: var(--stone);
            color: var(--stone);
        }

        /* Review System */
        .review-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--gold);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }

        .review-btn:hover {
            background: #b8911f;
        }

        .review-btn:disabled {
            background: var(--mist);
            color: var(--stone);
            cursor: not-allowed;
        }

        .review-btn .count {
            background: rgba(255,255,255,0.3);
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            font-size: 0.7rem;
        }

        .review-modal-content {
            text-align: center;
            max-width: 400px;
        }

        .review-word {
            font-family: 'Noto Serif JP', serif;
            font-size: 3rem;
            margin: 1.5rem 0;
            color: var(--ink);
        }

        .review-prompt {
            font-size: 0.9rem;
            color: var(--stone);
            margin-bottom: 1.5rem;
        }

        .reading-choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .reading-choice {
            padding: 1rem;
            border: 2px solid var(--mist);
            background: var(--paper);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        .reading-choice:hover {
            border-color: var(--vermillion);
            background: rgba(215, 59, 62, 0.05);
        }

        .reading-choice.correct {
            border-color: var(--gold);
            background: var(--gold-light);
            color: #8a7000;
        }

        .reading-choice.incorrect {
            border-color: var(--vermillion);
            background: rgba(215, 59, 62, 0.1);
            color: var(--vermillion);
        }

        .reading-choice:disabled {
            cursor: default;
        }

        .review-feedback {
            min-height: 3rem;
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .review-feedback.correct {
            background: var(--gold-light);
            color: #8a7000;
        }

        .review-feedback.incorrect {
            background: rgba(215, 59, 62, 0.1);
            color: var(--vermillion);
        }

        .review-feedback .meaning {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .review-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--stone);
        }

        .review-stats .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .review-stats .stat-num {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .review-stats .stat-num.gold { color: var(--gold); }
        .review-stats .stat-num.red { color: var(--vermillion); }

        @media (max-width: 600px) {
            /* Larger kanji tiles for touch */
            .kanji-grid {
                grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
                gap: 6px;
            }
            .kanji-char { font-size: 1.4rem; }

            .stats-row { gap: 0.5rem; }
            .stat-card { padding: 0.75rem; }
            .stat-value { font-size: 1.5rem; }

            /* LARGER canvas on mobile, not smaller */
            .writer-container {
                width: min(85vw, 320px);
                height: min(85vw, 320px);
            }
            .writer-container::before {
                background-size: calc(min(85vw, 320px) / 4) calc(min(85vw, 320px) / 4);
            }

            /* Modal improvements */
            .modal-content {
                padding: 1.5rem;
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
                padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
            }

            /* Larger touch targets for buttons */
            .modal-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .modal-actions .btn {
                width: 100%;
                min-height: 48px;
                font-size: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Larger close button */
            .close-modal {
                font-size: 2rem;
                padding: 0.5rem;
                min-width: 44px;
                min-height: 44px;
            }

            /* Grade headers more tappable */
            .grade-header {
                padding: 1.25rem 1rem;
                min-height: 56px;
            }

            /* Action bar adjustments */
            .action-bar {
                padding: 0.75rem;
            }
        }

        /* Safe area insets for notched phones */
        @supports (padding: env(safe-area-inset-bottom)) {
            .container {
                padding-left: max(1.5rem, env(safe-area-inset-left));
                padding-right: max(1.5rem, env(safe-area-inset-right));
                padding-bottom: env(safe-area-inset-bottom);
            }
            .modal-overlay {
                padding: env(safe-area-inset-top) env(safe-area-inset-right)
                         env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>漢字の道</h1>
            <div class="flight-badge">
                <span>✈</span>
                <span>JL0007 · BOS → NRT · July 27, 2026</span>
            </div>
            <button class="share-btn" onclick="openShareModal()" title="Share app">
                共有
            </button>
        </header>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value gold" id="learned-count">0</div>
                <div class="stat-label">Learned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value highlight" id="remaining-count">1026</div>
                <div class="stat-label">Remaining</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="days-left">209</div>
                <div class="stat-label">Days Left</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="per-day">5</div>
                <div class="stat-label">Per Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-value gold" id="streak-count">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="action-bar">
            <span class="selection-count" id="selection-info">Click any kanji to practice strokes</span>
            <button class="review-btn" id="review-btn" onclick="startReviewSession()" disabled>
                復習 <span class="count" id="review-count">0</span>
            </button>
        </div>

        <div id="grade-sections"></div>

        <div class="history-section">
            <div class="history-header">
                <span class="history-title">Recent Sessions</span>
                <button class="btn btn-secondary" onclick="exportData()">Export</button>
            </div>
            <div class="history-list" id="history-list">
                <div class="empty-state">
                    <div class="kanji">始</div>
                    <p>Click kanji above to begin</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Modal -->
    <div class="modal-overlay" id="practice-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div class="modal-header">
                Practice: <span class="target-char" id="modal-target"></span>
            </div>
            <div class="writer-container" id="writer-target"></div>
            <div class="modal-actions" id="modal-actions-main">
                <button class="btn btn-secondary" onclick="showAnimation()">Show Strokes</button>
                <button class="btn btn-secondary" onclick="retryQuiz()">Retry</button>
                <button class="btn btn-secondary" onclick="skipKanji()">Skip</button>
            </div>
            <div class="modal-actions" id="modal-actions-fallback" style="display: none;">
                <button class="btn btn-primary" onclick="markLearnedAnyway()">Mark Learned Anyway</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
            <div class="modal-status" id="modal-status"></div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal-content share-modal-content">
            <button class="close-modal" onclick="closeShareModal()">&times;</button>
            <h3>共有 — Share the Journey</h3>
            <div class="qr-container" id="qr-container">
                <!-- QR code generated here -->
            </div>
            <p style="font-size: 0.8rem; color: var(--stone); margin-bottom: 1rem;">
                Scan to open on another device
            </p>
            <div class="share-url">
                <input type="text" id="share-url-input" readonly value="https://robjohncolson.github.io/kanji/">
                <button class="btn btn-secondary" onclick="copyShareUrl()">Copy</button>
            </div>
            <div class="share-actions" id="native-share-container" style="display: none;">
                <button class="btn btn-primary" onclick="nativeShare()">Share via...</button>
            </div>
            <div class="copy-feedback" id="copy-feedback"></div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="review-modal">
        <div class="modal-content review-modal-content">
            <button class="close-modal" onclick="closeReviewModal()">&times;</button>
            <div class="review-prompt" id="review-prompt">How do you read this word?</div>
            <div class="review-word" id="review-word">一人</div>
            <div class="reading-choices" id="reading-choices">
                <!-- Choices populated by JS -->
            </div>
            <div class="review-feedback" id="review-feedback"></div>
            <div class="review-stats">
                <div class="stat">
                    <span class="stat-num gold" id="review-correct">0</span>
                    <span>Correct</span>
                </div>
                <div class="stat">
                    <span class="stat-num red" id="review-wrong">0</span>
                    <span>Wrong</span>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-primary" id="review-next-btn" onclick="nextReviewCard()" style="display: none;">Next</button>
                <button class="btn btn-secondary" onclick="closeReviewModal()">End Session</button>
            </div>
        </div>
    </div>

    <script>
        // Kanji Data by Grade
        const KANJI_BY_GRADE = {
            1: "一右雨円王音下火花貝学気九休玉金空月犬見五口校左三山子四糸字耳七車手十出女小上森人水正生青夕石赤千川先早草足村大男竹中虫町天田土二日入年白八百文木本名目立力林六",
            2: "刀丸弓工才万引牛元戸午公今止少心切太内父分方毛友外兄古広市矢台冬半母北用羽回会交光考行合寺自色西多地池当同肉米毎何角汽近形言谷作社図声走体弟売麦来里画岩京国姉知長直店東歩妹明門夜科海活計後思室首秋春食星前茶昼点南風夏家記帰原高紙時弱書通馬魚強教黄黒細週雪船組鳥野理雲絵間場晴朝答道買番園遠楽新数電話歌語算読聞鳴線親頭顔曜",
            3: "丁化区反予央去号皿仕写主申世他打代皮氷平由礼安曲血向死次式守州全有羊両列医究局君決住助身対投豆坂返役委育泳岸苦具幸使始事実者取受所昔注定波板表服物放味命油和屋界客急級係研県指持拾重昭乗神相送待炭柱追度畑発美秒品負面洋員院荷起宮庫根酒消真息速庭島配倍病勉流旅悪球祭終習宿商章深進族第帳笛転都動部問飲運温開階寒期軽湖港歯集暑勝植短着湯登等童悲筆遊葉陽落暗意感漢業詩想鉄農福路駅銀鼻様緑練横談調箱館橋整薬題",
            4: "欠氏井不夫以加功札司失必付辺包末未民令衣印各共好成争仲兆伝灯老位改完岐希求芸佐材児初臣折束沖低努阪兵別利良冷労英岡果芽官季泣協径固刷参治周松卒底的典奈念府阜法牧例茨栄軍建香昨祝城信省浅単栃飛変便約勇要案害挙訓郡候差残借笑席倉孫帯徒特梅浴料連貨械健康菜埼崎産鹿唱清巣側梨敗票副望陸媛賀街覚給極景結最散滋順焼然隊達博飯富満無量愛塩群試辞照節戦続置働管関旗漁熊察種静説徳億課潟器縄選熱標養輪機積録観験類願鏡議競",
            5: "久士支比仏圧永可刊旧句史示犯布弁因仮件再在団任囲応快技均告災志似序条状判防余易往価河居効妻枝舎述招制性毒版肥非武紀逆型限故厚査政祖則独保迷益桜格個耕航財殺師修素造能破粉脈容留移液眼基寄規救許経験現混採授術常情責接設率断張停堂得貧婦務略営過喜検減証象税絶測属貸貯提程統費備評復報貿解幹義禁鉱罪資飼準勢損墓豊夢演慣境構際雑酸精製総像増態適銅複綿領歴確潔賛質賞導編暴衛興築燃輸講謝績額織職識護",
            6: "干己寸亡尺収仁片穴冊処庁幼宇灰危机吸后至舌存宅我系孝困私否批忘乱卵延沿拡供券呼刻若宗承垂担宙忠届乳拝並宝枚胃映革巻看皇紅砂姿宣専泉洗染奏退段派背肺律恩株胸降骨座蚕射従純除将針値展討党納俳班秘俵陛朗異域郷済視捨推盛窓探著頂脳閉訪密訳郵欲翌割揮貴勤筋敬裁策詞就衆善創装尊痛晩補棒絹源署傷蒸聖誠暖腸賃腹幕盟預裏閣疑誤穀誌磁障銭層認暮模遺劇権熟諸蔵誕潮敵論激憲鋼樹縦操糖奮厳縮優覧簡難臨警臓"
        };

        const GRADE_NAMES = {
            1: "一年生",
            2: "二年生",
            3: "三年生",
            4: "四年生",
            5: "五年生",
            6: "六年生"
        };

        const TARGET_DATE = new Date('2026-07-27');
        const TOTAL_KANJI = 1026;

        // State
        let learnedKanji = new Set(JSON.parse(localStorage.getItem('learnedKanji') || '[]'));
        let history = JSON.parse(localStorage.getItem('kanjiHistory') || '[]');
        let expandedGrades = new Set([1]);
        let writer = null;
        let currentPracticeChar = null;
        let strokeDataLoaded = false;

        // Streak tracking
        let streakData = JSON.parse(localStorage.getItem('streakData') || '{"streak": 0, "lastPractice": null}');

        // SRS State
        let srsData = JSON.parse(localStorage.getItem('srsData') || '{}');
        let reviewSession = { queue: [], current: null, correct: 0, wrong: 0 };

        // Vocabulary Dataset - words using learned kanji with readings
        // Format: { word, reading, meaning, kanji (array of kanji used) }
        const VOCABULARY = [
            // Grade 1 vocabulary
            { word: "一人", reading: "ひとり", meaning: "one person / alone", kanji: ["一", "人"] },
            { word: "一日", reading: "いちにち", meaning: "one day", kanji: ["一", "日"] },
            { word: "一つ", reading: "ひとつ", meaning: "one thing", kanji: ["一"] },
            { word: "二人", reading: "ふたり", meaning: "two people", kanji: ["二", "人"] },
            { word: "二日", reading: "ふつか", meaning: "2nd day / two days", kanji: ["二", "日"] },
            { word: "三人", reading: "さんにん", meaning: "three people", kanji: ["三", "人"] },
            { word: "三日", reading: "みっか", meaning: "3rd day / three days", kanji: ["三", "日"] },
            { word: "四人", reading: "よにん", meaning: "four people", kanji: ["四", "人"] },
            { word: "四日", reading: "よっか", meaning: "4th day / four days", kanji: ["四", "日"] },
            { word: "五人", reading: "ごにん", meaning: "five people", kanji: ["五", "人"] },
            { word: "五日", reading: "いつか", meaning: "5th day / five days", kanji: ["五", "日"] },
            { word: "六日", reading: "むいか", meaning: "6th day / six days", kanji: ["六", "日"] },
            { word: "七日", reading: "なのか", meaning: "7th day / seven days", kanji: ["七", "日"] },
            { word: "八日", reading: "ようか", meaning: "8th day / eight days", kanji: ["八", "日"] },
            { word: "九日", reading: "ここのか", meaning: "9th day / nine days", kanji: ["九", "日"] },
            { word: "十日", reading: "とおか", meaning: "10th day / ten days", kanji: ["十", "日"] },
            { word: "百", reading: "ひゃく", meaning: "hundred", kanji: ["百"] },
            { word: "千", reading: "せん", meaning: "thousand", kanji: ["千"] },
            { word: "日本", reading: "にほん", meaning: "Japan", kanji: ["日", "本"] },
            { word: "本", reading: "ほん", meaning: "book", kanji: ["本"] },
            { word: "山", reading: "やま", meaning: "mountain", kanji: ["山"] },
            { word: "川", reading: "かわ", meaning: "river", kanji: ["川"] },
            { word: "火山", reading: "かざん", meaning: "volcano", kanji: ["火", "山"] },
            { word: "水", reading: "みず", meaning: "water", kanji: ["水"] },
            { word: "火", reading: "ひ", meaning: "fire", kanji: ["火"] },
            { word: "木", reading: "き", meaning: "tree", kanji: ["木"] },
            { word: "金", reading: "かね", meaning: "money / gold", kanji: ["金"] },
            { word: "土", reading: "つち", meaning: "earth / soil", kanji: ["土"] },
            { word: "月", reading: "つき", meaning: "moon / month", kanji: ["月"] },
            { word: "日", reading: "ひ", meaning: "sun / day", kanji: ["日"] },
            { word: "空", reading: "そら", meaning: "sky", kanji: ["空"] },
            { word: "雨", reading: "あめ", meaning: "rain", kanji: ["雨"] },
            { word: "花", reading: "はな", meaning: "flower", kanji: ["花"] },
            { word: "草", reading: "くさ", meaning: "grass", kanji: ["草"] },
            { word: "森", reading: "もり", meaning: "forest", kanji: ["森"] },
            { word: "林", reading: "はやし", meaning: "grove / woods", kanji: ["林"] },
            { word: "石", reading: "いし", meaning: "stone", kanji: ["石"] },
            { word: "竹", reading: "たけ", meaning: "bamboo", kanji: ["竹"] },
            { word: "虫", reading: "むし", meaning: "insect", kanji: ["虫"] },
            { word: "貝", reading: "かい", meaning: "shellfish", kanji: ["貝"] },
            { word: "犬", reading: "いぬ", meaning: "dog", kanji: ["犬"] },
            { word: "大きい", reading: "おおきい", meaning: "big", kanji: ["大"] },
            { word: "小さい", reading: "ちいさい", meaning: "small", kanji: ["小"] },
            { word: "上", reading: "うえ", meaning: "above / up", kanji: ["上"] },
            { word: "下", reading: "した", meaning: "below / down", kanji: ["下"] },
            { word: "中", reading: "なか", meaning: "inside / middle", kanji: ["中"] },
            { word: "左", reading: "ひだり", meaning: "left", kanji: ["左"] },
            { word: "右", reading: "みぎ", meaning: "right", kanji: ["右"] },
            { word: "出る", reading: "でる", meaning: "to exit / go out", kanji: ["出"] },
            { word: "入る", reading: "はいる", meaning: "to enter", kanji: ["入"] },
            { word: "見る", reading: "みる", meaning: "to see / look", kanji: ["見"] },
            { word: "手", reading: "て", meaning: "hand", kanji: ["手"] },
            { word: "足", reading: "あし", meaning: "foot / leg", kanji: ["足"] },
            { word: "口", reading: "くち", meaning: "mouth", kanji: ["口"] },
            { word: "耳", reading: "みみ", meaning: "ear", kanji: ["耳"] },
            { word: "目", reading: "め", meaning: "eye", kanji: ["目"] },
            { word: "男", reading: "おとこ", meaning: "man", kanji: ["男"] },
            { word: "女", reading: "おんな", meaning: "woman", kanji: ["女"] },
            { word: "子", reading: "こ", meaning: "child", kanji: ["子"] },
            { word: "男の子", reading: "おとこのこ", meaning: "boy", kanji: ["男", "子"] },
            { word: "女の子", reading: "おんなのこ", meaning: "girl", kanji: ["女", "子"] },
            { word: "人", reading: "ひと", meaning: "person", kanji: ["人"] },
            { word: "名前", reading: "なまえ", meaning: "name", kanji: ["名"] },
            { word: "先生", reading: "せんせい", meaning: "teacher", kanji: ["先", "生"] },
            { word: "生きる", reading: "いきる", meaning: "to live", kanji: ["生"] },
            { word: "学生", reading: "がくせい", meaning: "student", kanji: ["学", "生"] },
            { word: "学校", reading: "がっこう", meaning: "school", kanji: ["学", "校"] },
            { word: "学ぶ", reading: "まなぶ", meaning: "to learn", kanji: ["学"] },
            { word: "文字", reading: "もじ", meaning: "character / letter", kanji: ["文", "字"] },
            { word: "正しい", reading: "ただしい", meaning: "correct", kanji: ["正"] },
            { word: "青い", reading: "あおい", meaning: "blue", kanji: ["青"] },
            { word: "赤い", reading: "あかい", meaning: "red", kanji: ["赤"] },
            { word: "白い", reading: "しろい", meaning: "white", kanji: ["白"] },
            { word: "玉", reading: "たま", meaning: "ball / sphere", kanji: ["玉"] },
            { word: "王", reading: "おう", meaning: "king", kanji: ["王"] },
            { word: "円", reading: "えん", meaning: "yen / circle", kanji: ["円"] },
            { word: "音", reading: "おと", meaning: "sound", kanji: ["音"] },
            { word: "気", reading: "き", meaning: "spirit / energy", kanji: ["気"] },
            { word: "天気", reading: "てんき", meaning: "weather", kanji: ["天", "気"] },
            { word: "休む", reading: "やすむ", meaning: "to rest", kanji: ["休"] },
            { word: "糸", reading: "いと", meaning: "thread", kanji: ["糸"] },
            { word: "車", reading: "くるま", meaning: "car", kanji: ["車"] },
            { word: "年", reading: "とし", meaning: "year", kanji: ["年"] },
            { word: "今年", reading: "ことし", meaning: "this year", kanji: ["年"] },
            { word: "夕方", reading: "ゆうがた", meaning: "evening", kanji: ["夕"] },
            { word: "早い", reading: "はやい", meaning: "early / fast", kanji: ["早"] },
            { word: "町", reading: "まち", meaning: "town", kanji: ["町"] },
            { word: "村", reading: "むら", meaning: "village", kanji: ["村"] },
            { word: "田", reading: "た", meaning: "rice field", kanji: ["田"] },
            { word: "天", reading: "てん", meaning: "heaven / sky", kanji: ["天"] },
            { word: "立つ", reading: "たつ", meaning: "to stand", kanji: ["立"] },
            { word: "力", reading: "ちから", meaning: "power / strength", kanji: ["力"] },
            // Grade 2 vocabulary
            { word: "今日", reading: "きょう", meaning: "today", kanji: ["今", "日"] },
            { word: "明日", reading: "あした", meaning: "tomorrow", kanji: ["明", "日"] },
            { word: "友達", reading: "ともだち", meaning: "friend", kanji: ["友"] },
            { word: "父", reading: "ちち", meaning: "father", kanji: ["父"] },
            { word: "母", reading: "はは", meaning: "mother", kanji: ["母"] },
            { word: "兄", reading: "あに", meaning: "older brother", kanji: ["兄"] },
            { word: "姉", reading: "あね", meaning: "older sister", kanji: ["姉"] },
            { word: "弟", reading: "おとうと", meaning: "younger brother", kanji: ["弟"] },
            { word: "妹", reading: "いもうと", meaning: "younger sister", kanji: ["妹"] },
            { word: "家", reading: "いえ", meaning: "house / home", kanji: ["家"] },
            { word: "門", reading: "もん", meaning: "gate", kanji: ["門"] },
            { word: "店", reading: "みせ", meaning: "shop / store", kanji: ["店"] },
            { word: "電話", reading: "でんわ", meaning: "telephone", kanji: ["電", "話"] },
            { word: "歩く", reading: "あるく", meaning: "to walk", kanji: ["歩"] },
            { word: "走る", reading: "はしる", meaning: "to run", kanji: ["走"] },
            { word: "買う", reading: "かう", meaning: "to buy", kanji: ["買"] },
            { word: "売る", reading: "うる", meaning: "to sell", kanji: ["売"] },
            { word: "食べる", reading: "たべる", meaning: "to eat", kanji: ["食"] },
            { word: "飲む", reading: "のむ", meaning: "to drink", kanji: ["飲"] },
            { word: "読む", reading: "よむ", meaning: "to read", kanji: ["読"] },
            { word: "書く", reading: "かく", meaning: "to write", kanji: ["書"] },
            { word: "聞く", reading: "きく", meaning: "to hear / ask", kanji: ["聞"] },
            { word: "話す", reading: "はなす", meaning: "to speak", kanji: ["話"] },
            { word: "言う", reading: "いう", meaning: "to say", kanji: ["言"] },
            { word: "考える", reading: "かんがえる", meaning: "to think", kanji: ["考"] },
            { word: "知る", reading: "しる", meaning: "to know", kanji: ["知"] },
            { word: "思う", reading: "おもう", meaning: "to think / feel", kanji: ["思"] },
            { word: "会う", reading: "あう", meaning: "to meet", kanji: ["会"] },
            { word: "帰る", reading: "かえる", meaning: "to return home", kanji: ["帰"] },
            { word: "来る", reading: "くる", meaning: "to come", kanji: ["来"] },
            { word: "行く", reading: "いく", meaning: "to go", kanji: ["行"] },
            { word: "時間", reading: "じかん", meaning: "time", kanji: ["時", "間"] },
            { word: "朝", reading: "あさ", meaning: "morning", kanji: ["朝"] },
            { word: "昼", reading: "ひる", meaning: "noon / daytime", kanji: ["昼"] },
            { word: "夜", reading: "よる", meaning: "night", kanji: ["夜"] },
            { word: "春", reading: "はる", meaning: "spring", kanji: ["春"] },
            { word: "夏", reading: "なつ", meaning: "summer", kanji: ["夏"] },
            { word: "秋", reading: "あき", meaning: "autumn", kanji: ["秋"] },
            { word: "冬", reading: "ふゆ", meaning: "winter", kanji: ["冬"] },
            { word: "東", reading: "ひがし", meaning: "east", kanji: ["東"] },
            { word: "西", reading: "にし", meaning: "west", kanji: ["西"] },
            { word: "南", reading: "みなみ", meaning: "south", kanji: ["南"] },
            { word: "北", reading: "きた", meaning: "north", kanji: ["北"] },
            { word: "海", reading: "うみ", meaning: "sea / ocean", kanji: ["海"] },
            { word: "魚", reading: "さかな", meaning: "fish", kanji: ["魚"] },
            { word: "鳥", reading: "とり", meaning: "bird", kanji: ["鳥"] },
            { word: "馬", reading: "うま", meaning: "horse", kanji: ["馬"] },
            { word: "牛", reading: "うし", meaning: "cow", kanji: ["牛"] },
            { word: "雪", reading: "ゆき", meaning: "snow", kanji: ["雪"] },
            { word: "雲", reading: "くも", meaning: "cloud", kanji: ["雲"] },
            { word: "風", reading: "かぜ", meaning: "wind", kanji: ["風"] },
            { word: "星", reading: "ほし", meaning: "star", kanji: ["星"] },
            { word: "高い", reading: "たかい", meaning: "high / expensive", kanji: ["高"] },
            { word: "長い", reading: "ながい", meaning: "long", kanji: ["長"] },
            { word: "弱い", reading: "よわい", meaning: "weak", kanji: ["弱"] },
            { word: "強い", reading: "つよい", meaning: "strong", kanji: ["強"] },
            { word: "黒い", reading: "くろい", meaning: "black", kanji: ["黒"] },
            { word: "黄色い", reading: "きいろい", meaning: "yellow", kanji: ["黄", "色"] },
            { word: "新しい", reading: "あたらしい", meaning: "new", kanji: ["新"] },
            { word: "古い", reading: "ふるい", meaning: "old (things)", kanji: ["古"] },
            { word: "近い", reading: "ちかい", meaning: "near", kanji: ["近"] },
            { word: "遠い", reading: "とおい", meaning: "far", kanji: ["遠"] },
            { word: "多い", reading: "おおい", meaning: "many", kanji: ["多"] },
            { word: "少ない", reading: "すくない", meaning: "few", kanji: ["少"] },
            { word: "広い", reading: "ひろい", meaning: "wide / spacious", kanji: ["広"] },
            { word: "楽しい", reading: "たのしい", meaning: "fun / enjoyable", kanji: ["楽"] },
            { word: "茶", reading: "ちゃ", meaning: "tea", kanji: ["茶"] },
            { word: "米", reading: "こめ", meaning: "rice (uncooked)", kanji: ["米"] },
            { word: "肉", reading: "にく", meaning: "meat", kanji: ["肉"] },
            { word: "絵", reading: "え", meaning: "picture / painting", kanji: ["絵"] },
            { word: "歌", reading: "うた", meaning: "song", kanji: ["歌"] },
            { word: "歌う", reading: "うたう", meaning: "to sing", kanji: ["歌"] },
            { word: "答える", reading: "こたえる", meaning: "to answer", kanji: ["答"] },
            { word: "道", reading: "みち", meaning: "road / path", kanji: ["道"] },
            { word: "京都", reading: "きょうと", meaning: "Kyoto", kanji: ["京"] },
            { word: "東京", reading: "とうきょう", meaning: "Tokyo", kanji: ["東", "京"] },
            { word: "国", reading: "くに", meaning: "country", kanji: ["国"] },
            { word: "外国", reading: "がいこく", meaning: "foreign country", kanji: ["外", "国"] },
            // Grade 3+ vocabulary
            { word: "世界", reading: "せかい", meaning: "world", kanji: ["世", "界"] },
            { word: "仕事", reading: "しごと", meaning: "work / job", kanji: ["仕", "事"] },
            { word: "勉強", reading: "べんきょう", meaning: "study", kanji: ["勉", "強"] },
            { word: "練習", reading: "れんしゅう", meaning: "practice", kanji: ["練", "習"] },
            { word: "旅行", reading: "りょこう", meaning: "travel / trip", kanji: ["旅", "行"] },
            { word: "病院", reading: "びょういん", meaning: "hospital", kanji: ["病", "院"] },
            { word: "銀行", reading: "ぎんこう", meaning: "bank", kanji: ["銀", "行"] },
            { word: "駅", reading: "えき", meaning: "train station", kanji: ["駅"] },
            { word: "映画", reading: "えいが", meaning: "movie", kanji: ["映", "画"] },
            { word: "写真", reading: "しゃしん", meaning: "photograph", kanji: ["写", "真"] },
            { word: "問題", reading: "もんだい", meaning: "problem / question", kanji: ["問", "題"] },
            { word: "意味", reading: "いみ", meaning: "meaning", kanji: ["意", "味"] },
            { word: "感じ", reading: "かんじ", meaning: "feeling / kanji", kanji: ["感"] },
            { word: "漢字", reading: "かんじ", meaning: "kanji", kanji: ["漢", "字"] },
            { word: "運動", reading: "うんどう", meaning: "exercise / sports", kanji: ["運", "動"] },
            { word: "野菜", reading: "やさい", meaning: "vegetables", kanji: ["野", "菜"] }
        ];

        // Get all unique readings for distractors
        function getAllReadings() {
            return [...new Set(VOCABULARY.map(v => v.reading))];
        }

        // Get available vocab (words where all kanji are learned)
        function getAvailableVocab() {
            return VOCABULARY.filter(v => v.kanji.every(k => learnedKanji.has(k)));
        }

        // SRS Algorithm (simplified SM-2)
        function getSRSInterval(item) {
            const data = srsData[item.word] || { level: 0, nextReview: 0, easeFactor: 2.5 };
            return data;
        }

        function updateSRS(word, correct) {
            const now = Date.now();
            const data = srsData[word] || { level: 0, nextReview: 0, easeFactor: 2.5 };

            if (correct) {
                data.level = Math.min(data.level + 1, 8);
                // Intervals: 1min, 10min, 1hr, 8hr, 1day, 3day, 1week, 2weeks, 1month
                const intervals = [60000, 600000, 3600000, 28800000, 86400000, 259200000, 604800000, 1209600000, 2592000000];
                data.nextReview = now + intervals[Math.min(data.level, intervals.length - 1)];
                data.easeFactor = Math.min(data.easeFactor + 0.1, 3.0);
            } else {
                data.level = Math.max(0, data.level - 2);
                data.nextReview = now + 60000; // Review again in 1 min
                data.easeFactor = Math.max(1.3, data.easeFactor - 0.2);
            }

            srsData[word] = data;
            localStorage.setItem('srsData', JSON.stringify(srsData));
        }

        // Get items due for review
        function getDueReviews() {
            const now = Date.now();
            const available = getAvailableVocab();

            // Items due for review (past their nextReview time)
            const due = available.filter(v => {
                const data = srsData[v.word];
                if (!data) return true; // New items are due
                return data.nextReview <= now;
            });

            // Sort: new items first, then by nextReview time
            due.sort((a, b) => {
                const aData = srsData[a.word];
                const bData = srsData[b.word];
                if (!aData && bData) return -1;
                if (aData && !bData) return 1;
                if (!aData && !bData) return 0;
                return aData.nextReview - bData.nextReview;
            });

            return due;
        }

        function init() {
            checkStreak();
            renderGradeSections();
            updateStats();
            renderHistory();
            updateReviewButton();
        }

        function checkStreak() {
            if (!streakData.lastPractice) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const lastPractice = new Date(streakData.lastPractice);
            lastPractice.setHours(0, 0, 0, 0);

            const daysDiff = Math.floor((today - lastPractice) / (1000 * 60 * 60 * 24));

            if (daysDiff > 1) {
                // Streak broken
                streakData.streak = 0;
                saveStreak();
            }
        }

        function updateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!streakData.lastPractice) {
                // First practice ever
                streakData.streak = 1;
                streakData.lastPractice = today.toISOString();
            } else {
                const lastPractice = new Date(streakData.lastPractice);
                lastPractice.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((today - lastPractice) / (1000 * 60 * 60 * 24));

                if (daysDiff === 1) {
                    // Consecutive day - increment streak
                    streakData.streak++;
                    streakData.lastPractice = today.toISOString();
                } else if (daysDiff === 0) {
                    // Same day - keep streak, update timestamp
                    streakData.lastPractice = today.toISOString();
                } else {
                    // Streak broken, start fresh
                    streakData.streak = 1;
                    streakData.lastPractice = today.toISOString();
                }
            }
            saveStreak();
        }

        function saveStreak() {
            localStorage.setItem('streakData', JSON.stringify(streakData));
        }

        function renderGradeSections() {
            const container = document.getElementById('grade-sections');
            container.innerHTML = '';

            for (let grade = 1; grade <= 6; grade++) {
                const kanji = KANJI_BY_GRADE[grade];
                const learnedInGrade = [...kanji].filter(k => learnedKanji.has(k)).length;
                const isExpanded = expandedGrades.has(grade);

                const section = document.createElement('div');
                section.className = `grade-section ${isExpanded ? 'expanded' : ''}`;
                section.innerHTML = `
                    <div class="grade-header" onclick="toggleGrade(${grade})">
                        <span class="grade-title">
                            ${GRADE_NAMES[grade]}
                            <span class="grade-progress">
                                <span class="learned-count">${learnedInGrade}</span> / ${kanji.length}
                            </span>
                        </span>
                        <span class="grade-arrow">▼</span>
                    </div>
                    <div class="grade-content">
                        <div class="kanji-grid" id="grid-${grade}"></div>
                    </div>
                `;
                container.appendChild(section);

                if (isExpanded) {
                    renderKanjiGrid(grade);
                }
            }
        }

        function toggleGrade(grade) {
            if (expandedGrades.has(grade)) {
                expandedGrades.delete(grade);
            } else {
                expandedGrades.add(grade);
            }
            renderGradeSections();
        }

        function renderKanjiGrid(grade) {
            const container = document.getElementById(`grid-${grade}`);
            if (!container) return;

            const kanji = KANJI_BY_GRADE[grade];
            container.innerHTML = '';

            for (const char of kanji) {
                const div = document.createElement('div');
                div.className = 'kanji-char';
                div.textContent = char;

                if (learnedKanji.has(char)) {
                    div.classList.add('learned');
                }

                div.onclick = () => handleKanjiClick(char, div);
                container.appendChild(div);
            }
        }

        function handleKanjiClick(char, element) {
            // Always open practice modal - practice required to mark as learned
            openPracticeModal(char);
        }

        // Practice Modal
        function openPracticeModal(char) {
            currentPracticeChar = char;
            strokeDataLoaded = false;

            const modal = document.getElementById('practice-modal');
            const target = document.getElementById('writer-target');

            document.getElementById('modal-target').textContent = char;
            document.getElementById('modal-status').textContent = '';
            document.getElementById('modal-status').className = 'modal-status';

            // Reset action buttons visibility
            document.getElementById('modal-actions-main').style.display = 'flex';
            document.getElementById('modal-actions-fallback').style.display = 'none';

            // Lock body scroll on mobile
            document.body.classList.add('modal-open');

            modal.classList.add('active');
            target.innerHTML = '';

            // Dynamic canvas size based on container (responsive)
            const containerStyle = getComputedStyle(target);
            const canvasSize = Math.min(
                parseInt(containerStyle.width) || 280,
                parseInt(containerStyle.height) || 280
            );
            const isMobile = window.innerWidth <= 600;

            // Create HanziWriter with Japanese data preference
            writer = HanziWriter.create('writer-target', char, {
                width: canvasSize,
                height: canvasSize,
                padding: 20,
                showOutline: true,
                strokeAnimationSpeed: 1.5,
                delayBetweenStrokes: 150,
                strokeColor: '#1a1a1a',
                radicalColor: '#d73b3e',
                highlightColor: '#c9a227',
                outlineColor: '#e8e4dc',
                drawingColor: '#1a1a1a',
                leniency: isMobile ? 1.5 : 1.2, // More forgiving on mobile
                showHintAfterMisses: isMobile ? 2 : 3, // Faster hints on mobile
                charDataLoader: function(char, onComplete, onErr) {
                    // Try Japanese data first (@jamsch package), fallback to Chinese
                    fetch(`https://cdn.jsdelivr.net/npm/@jamsch/hanzi-writer-data-jp@2.0.2/${char}.json`)
                        .then(res => {
                            if (!res.ok) throw new Error('JP data not found');
                            return res.json();
                        })
                        .then(data => {
                            strokeDataLoaded = true;
                            onComplete(data);
                        })
                        .catch(() => {
                            // Fallback to default Chinese data
                            fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                                .then(res => {
                                    if (!res.ok) throw new Error('Data not found');
                                    return res.json();
                                })
                                .then(data => {
                                    strokeDataLoaded = true;
                                    onComplete(data);
                                })
                                .catch(err => {
                                    strokeDataLoaded = false;
                                    showDataUnavailable();
                                    if (onErr) onErr(err);
                                });
                        });
                }
            });

            // Start quiz mode
            startQuiz();
        }

        function startQuiz() {
            if (!writer) return;

            writer.quiz({
                onMistake: function(strokeData) {
                    document.getElementById('modal-status').textContent =
                        `Stroke ${strokeData.strokeNum + 1}: Try again`;
                    document.getElementById('modal-status').className = 'modal-status error';
                },
                onCorrectStroke: function(strokeData) {
                    document.getElementById('modal-status').textContent = '';
                },
                onComplete: function(summaryData) {
                    // Success!
                    document.getElementById('modal-status').textContent = 'Mastered!';
                    document.getElementById('modal-status').className = 'modal-status success';

                    // Auto-mark as learned after brief delay
                    setTimeout(() => {
                        markAsLearned(currentPracticeChar);
                        closeModal();
                    }, 800);
                }
            });
        }

        function showAnimation() {
            if (writer) {
                writer.cancelQuiz();
                writer.animateCharacter({
                    onComplete: () => {
                        setTimeout(startQuiz, 500);
                    }
                });
            }
        }

        function retryQuiz() {
            if (writer) {
                writer.cancelQuiz();
                document.getElementById('modal-status').textContent = '';
                document.getElementById('modal-status').className = 'modal-status';
                startQuiz();
            }
        }

        function skipKanji() {
            closeModal();
        }

        function showDataUnavailable() {
            // Show fallback UI when stroke data can't be loaded
            document.getElementById('modal-actions-main').style.display = 'none';
            document.getElementById('modal-actions-fallback').style.display = 'flex';
            document.getElementById('modal-status').textContent =
                'Stroke data unavailable — network error or unsupported kanji';
            document.getElementById('modal-status').className = 'modal-status error';
        }

        function markLearnedAnyway() {
            // Fallback: mark as learned without practice (only when data unavailable)
            if (currentPracticeChar) {
                markAsLearned(currentPracticeChar, 'fallback');
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('practice-modal').classList.remove('active');
            document.body.classList.remove('modal-open'); // Restore body scroll
            if (writer) {
                writer.cancelQuiz();
                writer = null;
            }
            currentPracticeChar = null;
        }

        function markAsLearned(char, method = 'practice') {
            if (learnedKanji.has(char)) return;

            learnedKanji.add(char);

            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                kanji: char,
                count: 1,
                method: method // 'practice' or 'fallback'
            };
            history.unshift(entry);

            updateStreak(); // Track daily practice
            save();
            renderGradeSections();
            updateStats();
            renderHistory();
            updateReviewButton(); // New vocab may be available
        }

        function save() {
            localStorage.setItem('learnedKanji', JSON.stringify([...learnedKanji]));
            localStorage.setItem('kanjiHistory', JSON.stringify(history));
        }

        function updateStats() {
            const learned = learnedKanji.size;
            const remaining = TOTAL_KANJI - learned;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysLeft = Math.max(0, Math.ceil((TARGET_DATE - today) / (1000 * 60 * 60 * 24)));
            const perDay = daysLeft > 0 ? Math.ceil(remaining / daysLeft) : 0;
            const percent = (learned / TOTAL_KANJI) * 100;

            document.getElementById('learned-count').textContent = learned;
            document.getElementById('remaining-count').textContent = remaining;
            document.getElementById('days-left').textContent = daysLeft;
            document.getElementById('per-day').textContent = perDay;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('streak-count').textContent = streakData.streak;
        }

        function renderHistory() {
            const container = document.getElementById('history-list');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="kanji">始</div>
                        <p>Click kanji above to begin</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.slice(0, 10).map(entry => {
                const date = new Date(entry.date);
                const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const icon = entry.method === 'practice' ? '✍' : (entry.method === 'fallback' ? '⚠' : '');
                return `
                    <div class="history-item">
                        <span class="history-kanji">${icon}${entry.kanji}</span>
                        <div class="history-meta">
                            <div class="history-count">+${entry.count}</div>
                            <div>${formatted}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportData() {
            const data = {
                learnedKanji: [...learnedKanji],
                history: history,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanji-journey-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Share Modal Functions
        const SHARE_URL = 'https://robjohncolson.github.io/kanji/';

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            document.body.classList.add('modal-open');
            modal.classList.add('active');

            // Generate QR code using qrcode-generator library
            const container = document.getElementById('qr-container');
            try {
                const qr = qrcode(0, 'M');
                qr.addData(SHARE_URL);
                qr.make();

                // Create image from QR code
                container.innerHTML = qr.createImgTag(5, 10);
                // Style the generated image
                const img = container.querySelector('img');
                if (img) {
                    img.style.display = 'block';
                }
            } catch (err) {
                console.error('QR generation failed:', err);
                container.innerHTML = '<div style="padding: 2rem; color: #666;">QR unavailable</div>';
            }

            // Show native share button if supported
            if (navigator.share) {
                document.getElementById('native-share-container').style.display = 'flex';
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('copy-feedback').textContent = '';
        }

        function copyShareUrl() {
            const input = document.getElementById('share-url-input');
            navigator.clipboard.writeText(input.value).then(() => {
                document.getElementById('copy-feedback').textContent = 'Link copied!';
                setTimeout(() => {
                    document.getElementById('copy-feedback').textContent = '';
                }, 2000);
            });
        }

        async function nativeShare() {
            try {
                await navigator.share({
                    title: '漢字の道 — Kanji Journey',
                    text: `I'm learning ${learnedKanji.size} of 1,026 kanji before my Japan trip! Try this practice app:`,
                    url: SHARE_URL
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    copyShareUrl(); // Fallback to copy
                }
            }
        }

        // Review Session Functions
        function updateReviewButton() {
            const due = getDueReviews();
            const btn = document.getElementById('review-btn');
            const count = document.getElementById('review-count');

            count.textContent = due.length;
            btn.disabled = due.length === 0;
        }

        function startReviewSession() {
            const due = getDueReviews();
            if (due.length === 0) return;

            // Take up to 10 items for this session
            reviewSession.queue = due.slice(0, 10);
            reviewSession.current = null;
            reviewSession.correct = 0;
            reviewSession.wrong = 0;

            document.getElementById('review-correct').textContent = '0';
            document.getElementById('review-wrong').textContent = '0';

            const modal = document.getElementById('review-modal');
            document.body.classList.add('modal-open');
            modal.classList.add('active');

            nextReviewCard();
        }

        function nextReviewCard() {
            const feedback = document.getElementById('review-feedback');
            feedback.className = 'review-feedback';
            feedback.innerHTML = '';

            document.getElementById('review-next-btn').style.display = 'none';

            if (reviewSession.queue.length === 0) {
                // Session complete
                showSessionComplete();
                return;
            }

            reviewSession.current = reviewSession.queue.shift();
            displayReviewCard(reviewSession.current);
        }

        function displayReviewCard(item) {
            document.getElementById('review-word').textContent = item.word;

            // Generate choices: correct answer + 3 distractors
            const allReadings = getAllReadings();
            const distractors = allReadings
                .filter(r => r !== item.reading)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const choices = [item.reading, ...distractors].sort(() => Math.random() - 0.5);

            const container = document.getElementById('reading-choices');
            container.innerHTML = choices.map(reading => `
                <button class="reading-choice" onclick="checkAnswer('${reading}')">${reading}</button>
            `).join('');
        }

        function checkAnswer(selected) {
            const item = reviewSession.current;
            const correct = selected === item.reading;

            // Update SRS
            updateSRS(item.word, correct);

            // Update session stats
            if (correct) {
                reviewSession.correct++;
                document.getElementById('review-correct').textContent = reviewSession.correct;
            } else {
                reviewSession.wrong++;
                document.getElementById('review-wrong').textContent = reviewSession.wrong;
                // Add back to queue for retry
                reviewSession.queue.push(item);
            }

            // Mark buttons
            const buttons = document.querySelectorAll('.reading-choice');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === item.reading) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selected && !correct) {
                    btn.classList.add('incorrect');
                }
            });

            // Show feedback
            const feedback = document.getElementById('review-feedback');
            if (correct) {
                feedback.className = 'review-feedback correct';
                feedback.innerHTML = `<div>Correct!</div><div class="meaning">${item.meaning}</div>`;
            } else {
                feedback.className = 'review-feedback incorrect';
                feedback.innerHTML = `<div>The answer is: ${item.reading}</div><div class="meaning">${item.meaning}</div>`;
            }

            // Show next button
            document.getElementById('review-next-btn').style.display = 'inline-block';
        }

        function showSessionComplete() {
            document.getElementById('review-word').textContent = '完了!';
            document.getElementById('reading-choices').innerHTML = '';

            const feedback = document.getElementById('review-feedback');
            const total = reviewSession.correct + reviewSession.wrong;
            const accuracy = total > 0 ? Math.round((reviewSession.correct / total) * 100) : 0;

            feedback.className = 'review-feedback correct';
            feedback.innerHTML = `
                <div style="font-size: 1.2rem;">Session Complete</div>
                <div class="meaning">${accuracy}% accuracy</div>
            `;

            document.getElementById('review-next-btn').style.display = 'none';
            updateReviewButton();
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            updateReviewButton();
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeShareModal();
                closeReviewModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('practice-modal').addEventListener('click', (e) => {
            if (e.target.id === 'practice-modal') closeModal();
        });

        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') closeShareModal();
        });

        document.getElementById('review-modal').addEventListener('click', (e) => {
            if (e.target.id === 'review-modal') closeReviewModal();
        });

        init();
    </script>
</body>
</html>
