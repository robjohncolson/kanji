<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>漢字の道 — Kanji Journey to Japan</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        :root {
            --ink: #1a1a1a;
            --paper: #f7f5f0;
            --washi: #faf8f3;
            --vermillion: #d73b3e;
            --gold: #c9a227;
            --gold-light: rgba(201, 162, 39, 0.2);
            --stone: #6b6b6b;
            --mist: #e8e4dc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--paper);
            color: var(--ink);
            min-height: 100vh;
        }

        /* Lock scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
            overscroll-behavior: none;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--mist);
        }

        h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 2rem;
            font-weight: 400;
            letter-spacing: 0.1em;
        }

        .flight-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--stone);
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 120px;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-family: 'Noto Serif JP', serif;
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-value.highlight { color: var(--vermillion); }
        .stat-value.gold { color: var(--gold); }

        .stat-label {
            font-size: 0.7rem;
            color: var(--stone);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Progress Bar */
        .progress-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 10px;
            background: var(--mist);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--vermillion), var(--gold));
            transition: width 0.3s ease;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--vermillion);
            color: white;
        }

        .btn-primary:hover { background: #c13033; }
        .btn-primary:disabled {
            background: var(--mist);
            color: var(--stone);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--mist);
            color: var(--stone);
        }

        .btn-secondary:hover {
            border-color: var(--ink);
            color: var(--ink);
        }

        .mode-toggle {
            display: flex;
            background: var(--paper);
            border: 1px solid var(--mist);
            border-radius: 4px;
            overflow: hidden;
        }

        .mode-btn {
            padding: 0.5rem 0.8rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s;
            color: var(--stone);
        }

        .mode-btn.active {
            background: var(--ink);
            color: var(--paper);
        }

        .selection-count {
            font-size: 0.85rem;
            color: var(--stone);
            margin-left: auto;
        }

        .selection-count strong {
            color: var(--vermillion);
            font-size: 1.1rem;
        }

        /* Grade Sections */
        .grade-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            margin-bottom: 0.5rem;
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .grade-header:hover {
            background: rgba(0,0,0,0.02);
        }

        .grade-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .grade-progress {
            font-size: 0.8rem;
            color: var(--stone);
            background: var(--paper);
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
        }

        .grade-progress .learned-count {
            color: var(--gold);
            font-weight: 600;
        }

        .grade-arrow {
            font-size: 0.8rem;
            color: var(--stone);
            transition: transform 0.2s ease;
        }

        .grade-section.expanded .grade-arrow {
            transform: rotate(180deg);
        }

        .grade-content {
            display: none;
            padding: 0 1rem 1rem;
        }

        .grade-section.expanded .grade-content {
            display: block;
        }

        /* Kanji Grid */
        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
            gap: 4px;
        }

        .kanji-char {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--paper);
            border: 1px solid var(--mist);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }

        .kanji-char:hover {
            border-color: var(--vermillion);
            transform: scale(1.1);
            z-index: 1;
        }

        .kanji-char.learned {
            background: var(--gold-light);
            border-color: var(--gold);
            color: #8a7000;
        }

        .kanji-char.learned::after {
            content: '✓';
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.5rem;
            color: var(--gold);
        }

        /* History */
        .history-section {
            background: var(--washi);
            border: 1px solid var(--mist);
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .history-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 1rem;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--mist);
            font-size: 0.85rem;
        }

        .history-item:last-child { border-bottom: none; }

        .history-kanji {
            font-size: 1rem;
            letter-spacing: 0.1em;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-meta {
            text-align: right;
            color: var(--stone);
        }

        .history-count {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            color: var(--gold);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--stone);
        }

        .empty-state .kanji {
            font-family: 'Noto Serif JP', serif;
            font-size: 3rem;
            color: var(--mist);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--paper);
            padding: 2rem;
            border-radius: 2px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 380px;
            position: relative;
            border: 1px solid var(--mist);
        }

        .modal-header {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: var(--ink);
        }

        .modal-header .target-char {
            font-size: 2rem;
            color: var(--vermillion);
        }

        .writer-container {
            width: 280px;
            height: 280px;
            margin: 0 auto 1.5rem;
            border: 1px solid var(--stone);
            background: white;
            position: relative;
            touch-action: none; /* Prevent scroll/zoom while drawing */
        }

        /* 4x4 Grid overlay */
        .writer-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(var(--mist) 1px, transparent 1px),
                linear-gradient(90deg, var(--mist) 1px, transparent 1px);
            background-size: 70px 70px;
            pointer-events: none;
            z-index: 1;
        }

        /* Cross guidelines */
        .writer-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(var(--mist) 1px, transparent 1px) 0 139px / 100% 2px no-repeat,
                linear-gradient(90deg, var(--mist) 1px, transparent 1px) 139px 0 / 2px 100% no-repeat;
            pointer-events: none;
            z-index: 1;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--stone);
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--ink);
        }

        .modal-status {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--stone);
            min-height: 1.2em;
        }

        .modal-status.success {
            color: var(--gold);
            font-weight: 600;
        }

        .modal-status.error {
            color: var(--vermillion);
        }

        /* Share Button */
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: transparent;
            border: 1px solid var(--mist);
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            margin-top: 0.75rem;
            color: var(--stone);
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s ease;
        }

        .share-btn:hover {
            border-color: var(--vermillion);
            color: var(--vermillion);
        }

        /* Share Modal */
        .share-modal-content {
            text-align: center;
        }

        .share-modal-content h3 {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .qr-container {
            background: white;
            padding: 1rem;
            display: inline-block;
            margin-bottom: 1rem;
            border: 1px solid var(--mist);
        }

        .share-url {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .share-url input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--mist);
            background: var(--paper);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.85rem;
            color: var(--ink);
        }

        .share-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .copy-feedback {
            font-size: 0.8rem;
            color: var(--gold);
            min-height: 1.2em;
            margin-top: 0.5rem;
        }

        /* Streak Badge */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: var(--gold-light);
            border: 1px solid var(--gold);
            padding: 0.25rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            color: var(--gold);
            margin-left: 0.5rem;
        }

        .streak-badge.inactive {
            background: var(--mist);
            border-color: var(--stone);
            color: var(--stone);
        }

        /* Review System */
        .review-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--gold);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.2s ease;
            margin-left: 0.5rem;
        }

        .review-btn:hover {
            background: #b8911f;
        }

        .review-btn:disabled {
            background: var(--mist);
            color: var(--stone);
            cursor: not-allowed;
        }

        .review-btn .count {
            background: rgba(255,255,255,0.3);
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            font-size: 0.7rem;
        }

        .review-modal-content {
            text-align: center;
            max-width: 400px;
        }

        .review-word {
            font-family: 'Noto Serif JP', serif;
            font-size: 3rem;
            margin: 1.5rem 0;
            color: var(--ink);
        }

        .review-prompt {
            font-size: 0.9rem;
            color: var(--stone);
            margin-bottom: 1.5rem;
        }

        .reading-choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .reading-choice {
            padding: 1rem;
            border: 2px solid var(--mist);
            background: var(--paper);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 4px;
        }

        .reading-choice:hover {
            border-color: var(--vermillion);
            background: rgba(215, 59, 62, 0.05);
        }

        .reading-choice.correct {
            border-color: var(--gold);
            background: var(--gold-light);
            color: #8a7000;
        }

        .reading-choice.incorrect {
            border-color: var(--vermillion);
            background: rgba(215, 59, 62, 0.1);
            color: var(--vermillion);
        }

        .reading-choice:disabled {
            cursor: default;
        }

        .review-feedback {
            min-height: 3rem;
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 4px;
        }

        .review-feedback.correct {
            background: var(--gold-light);
            color: #8a7000;
        }

        .review-feedback.incorrect {
            background: rgba(215, 59, 62, 0.1);
            color: var(--vermillion);
        }

        .review-feedback .meaning {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .review-feedback .all-readings {
            font-size: 0.9rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 4px;
        }

        .review-feedback .current-reading {
            color: var(--gold);
            font-weight: 600;
        }

        .review-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--stone);
        }

        .review-stats .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .review-stats .stat-num {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .review-stats .stat-num.gold { color: var(--gold); }
        .review-stats .stat-num.red { color: var(--vermillion); }

        @media (max-width: 600px) {
            /* Larger kanji tiles for touch */
            .kanji-grid {
                grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
                gap: 6px;
            }
            .kanji-char { font-size: 1.4rem; }

            .stats-row { gap: 0.5rem; }
            .stat-card { padding: 0.75rem; }
            .stat-value { font-size: 1.5rem; }

            /* LARGER canvas on mobile, not smaller */
            .writer-container {
                width: min(85vw, 320px);
                height: min(85vw, 320px);
            }
            .writer-container::before {
                background-size: calc(min(85vw, 320px) / 4) calc(min(85vw, 320px) / 4);
            }

            /* Modal improvements */
            .modal-content {
                padding: 1.5rem;
                width: 95%;
                max-height: 90vh;
                overflow-y: auto;
                padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
            }

            /* Larger touch targets for buttons */
            .modal-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .modal-actions .btn {
                width: 100%;
                min-height: 48px;
                font-size: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Larger close button */
            .close-modal {
                font-size: 2rem;
                padding: 0.5rem;
                min-width: 44px;
                min-height: 44px;
            }

            /* Grade headers more tappable */
            .grade-header {
                padding: 1.25rem 1rem;
                min-height: 56px;
            }

            /* Action bar adjustments */
            .action-bar {
                padding: 0.75rem;
            }
        }

        /* Safe area insets for notched phones */
        @supports (padding: env(safe-area-inset-bottom)) {
            .container {
                padding-left: max(1.5rem, env(safe-area-inset-left));
                padding-right: max(1.5rem, env(safe-area-inset-right));
                padding-bottom: env(safe-area-inset-bottom);
            }
            .modal-overlay {
                padding: env(safe-area-inset-top) env(safe-area-inset-right)
                         env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>漢字の道</h1>
            <div class="flight-badge">
                <span>✈</span>
                <span>JL0007 · BOS → NRT · July 27, 2026</span>
            </div>
            <button class="share-btn" onclick="openShareModal()" title="Share app">
                共有
            </button>
        </header>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value gold" id="learned-count">0</div>
                <div class="stat-label">Learned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value highlight" id="remaining-count">1026</div>
                <div class="stat-label">Remaining</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="days-left">209</div>
                <div class="stat-label">Days Left</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="per-day">5</div>
                <div class="stat-label">Per Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-value gold" id="streak-count">0</div>
                <div class="stat-label">Day Streak</div>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="action-bar">
            <span class="selection-count" id="selection-info">Click any kanji to practice strokes</span>
            <button class="review-btn" id="review-btn" onclick="startReviewSession()" disabled>
                復習 <span class="count" id="review-count">0</span>
            </button>
        </div>

        <div id="grade-sections"></div>

        <div class="history-section">
            <div class="history-header">
                <span class="history-title">Recent Sessions</span>
                <button class="btn btn-secondary" onclick="exportData()">Export</button>
            </div>
            <div class="history-list" id="history-list">
                <div class="empty-state">
                    <div class="kanji">始</div>
                    <p>Click kanji above to begin</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Modal -->
    <div class="modal-overlay" id="practice-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <div class="modal-header">
                Practice: <span class="target-char" id="modal-target"></span>
            </div>
            <div class="writer-container" id="writer-target"></div>
            <div class="modal-actions" id="modal-actions-main">
                <button class="btn btn-secondary" onclick="showAnimation()">Show Strokes</button>
                <button class="btn btn-secondary" onclick="retryQuiz()">Retry</button>
                <button class="btn btn-secondary" onclick="skipKanji()">Skip</button>
            </div>
            <div class="modal-actions" id="modal-actions-fallback" style="display: none;">
                <button class="btn btn-primary" onclick="markLearnedAnyway()">Mark Learned Anyway</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
            <div class="modal-status" id="modal-status"></div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal-content share-modal-content">
            <button class="close-modal" onclick="closeShareModal()">&times;</button>
            <h3>共有 — Share the Journey</h3>
            <div class="qr-container" id="qr-container">
                <!-- QR code generated here -->
            </div>
            <p style="font-size: 0.8rem; color: var(--stone); margin-bottom: 1rem;">
                Scan to open on another device
            </p>
            <div class="share-url">
                <input type="text" id="share-url-input" readonly value="https://robjohncolson.github.io/kanji/">
                <button class="btn btn-secondary" onclick="copyShareUrl()">Copy</button>
            </div>
            <div class="share-actions" id="native-share-container" style="display: none;">
                <button class="btn btn-primary" onclick="nativeShare()">Share via...</button>
            </div>
            <div class="copy-feedback" id="copy-feedback"></div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="review-modal">
        <div class="modal-content review-modal-content">
            <button class="close-modal" onclick="closeReviewModal()">&times;</button>
            <div class="review-prompt" id="review-prompt">How do you read this word?</div>
            <div class="review-word" id="review-word">一人</div>
            <div class="reading-choices" id="reading-choices">
                <!-- Choices populated by JS -->
            </div>
            <div class="review-feedback" id="review-feedback"></div>
            <div class="review-stats">
                <div class="stat">
                    <span class="stat-num gold" id="review-correct">0</span>
                    <span>Correct</span>
                </div>
                <div class="stat">
                    <span class="stat-num red" id="review-wrong">0</span>
                    <span>Wrong</span>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-primary" id="review-next-btn" onclick="nextReviewCard()" style="display: none;">Next</button>
                <button class="btn btn-secondary" onclick="closeReviewModal()">End Session</button>
            </div>
        </div>
    </div>

    <script>
        // Kanji Data by Grade
        const KANJI_BY_GRADE = {
            1: "一右雨円王音下火花貝学気九休玉金空月犬見五口校左三山子四糸字耳七車手十出女小上森人水正生青夕石赤千川先早草足村大男竹中虫町天田土二日入年白八百文木本名目立力林六",
            2: "刀丸弓工才万引牛元戸午公今止少心切太内父分方毛友外兄古広市矢台冬半母北用羽回会交光考行合寺自色西多地池当同肉米毎何角汽近形言谷作社図声走体弟売麦来里画岩京国姉知長直店東歩妹明門夜科海活計後思室首秋春食星前茶昼点南風夏家記帰原高紙時弱書通馬魚強教黄黒細週雪船組鳥野理雲絵間場晴朝答道買番園遠楽新数電話歌語算読聞鳴線親頭顔曜",
            3: "丁化区反予央去号皿仕写主申世他打代皮氷平由礼安曲血向死次式守州全有羊両列医究局君決住助身対投豆坂返役委育泳岸苦具幸使始事実者取受所昔注定波板表服物放味命油和屋界客急級係研県指持拾重昭乗神相送待炭柱追度畑発美秒品負面洋員院荷起宮庫根酒消真息速庭島配倍病勉流旅悪球祭終習宿商章深進族第帳笛転都動部問飲運温開階寒期軽湖港歯集暑勝植短着湯登等童悲筆遊葉陽落暗意感漢業詩想鉄農福路駅銀鼻様緑練横談調箱館橋整薬題",
            4: "欠氏井不夫以加功札司失必付辺包末未民令衣印各共好成争仲兆伝灯老位改完岐希求芸佐材児初臣折束沖低努阪兵別利良冷労英岡果芽官季泣協径固刷参治周松卒底的典奈念府阜法牧例茨栄軍建香昨祝城信省浅単栃飛変便約勇要案害挙訓郡候差残借笑席倉孫帯徒特梅浴料連貨械健康菜埼崎産鹿唱清巣側梨敗票副望陸媛賀街覚給極景結最散滋順焼然隊達博飯富満無量愛塩群試辞照節戦続置働管関旗漁熊察種静説徳億課潟器縄選熱標養輪機積録観験類願鏡議競",
            5: "久士支比仏圧永可刊旧句史示犯布弁因仮件再在団任囲応快技均告災志似序条状判防余易往価河居効妻枝舎述招制性毒版肥非武紀逆型限故厚査政祖則独保迷益桜格個耕航財殺師修素造能破粉脈容留移液眼基寄規救許経験現混採授術常情責接設率断張停堂得貧婦務略営過喜検減証象税絶測属貸貯提程統費備評復報貿解幹義禁鉱罪資飼準勢損墓豊夢演慣境構際雑酸精製総像増態適銅複綿領歴確潔賛質賞導編暴衛興築燃輸講謝績額織職識護",
            6: "干己寸亡尺収仁片穴冊処庁幼宇灰危机吸后至舌存宅我系孝困私否批忘乱卵延沿拡供券呼刻若宗承垂担宙忠届乳拝並宝枚胃映革巻看皇紅砂姿宣専泉洗染奏退段派背肺律恩株胸降骨座蚕射従純除将針値展討党納俳班秘俵陛朗異域郷済視捨推盛窓探著頂脳閉訪密訳郵欲翌割揮貴勤筋敬裁策詞就衆善創装尊痛晩補棒絹源署傷蒸聖誠暖腸賃腹幕盟預裏閣疑誤穀誌磁障銭層認暮模遺劇権熟諸蔵誕潮敵論激憲鋼樹縦操糖奮厳縮優覧簡難臨警臓"
        };

        const GRADE_NAMES = {
            1: "一年生",
            2: "二年生",
            3: "三年生",
            4: "四年生",
            5: "五年生",
            6: "六年生"
        };

        const TARGET_DATE = new Date('2026-07-27');
        const TOTAL_KANJI = 1026;

        // State
        let learnedKanji = new Set(JSON.parse(localStorage.getItem('learnedKanji') || '[]'));
        let history = JSON.parse(localStorage.getItem('kanjiHistory') || '[]');
        let expandedGrades = new Set([1]);
        let writer = null;
        let currentPracticeChar = null;
        let strokeDataLoaded = false;

        // Streak tracking
        let streakData = JSON.parse(localStorage.getItem('streakData') || '{"streak": 0, "lastPractice": null}');

        // SRS State
        let srsData = JSON.parse(localStorage.getItem('srsData') || '{}');
        let reviewSession = { queue: [], current: null, correct: 0, wrong: 0 };

        // Vocabulary Dataset - words using learned kanji with readings
        // Format: { word, reading, meaning, kanji (array of kanji used) }
        const VOCABULARY = [
            // Grade 1 vocabulary
            { word: "一人", reading: "ひとり", meaning: "one person / alone", kanji: ["一", "人"] },
            { word: "一日", reading: "いちにち", meaning: "one day", kanji: ["一", "日"] },
            { word: "一つ", reading: "ひとつ", meaning: "one thing", kanji: ["一"] },
            { word: "二人", reading: "ふたり", meaning: "two people", kanji: ["二", "人"] },
            { word: "二日", reading: "ふつか", meaning: "2nd day / two days", kanji: ["二", "日"] },
            { word: "三人", reading: "さんにん", meaning: "three people", kanji: ["三", "人"] },
            { word: "三日", reading: "みっか", meaning: "3rd day / three days", kanji: ["三", "日"] },
            { word: "四人", reading: "よにん", meaning: "four people", kanji: ["四", "人"] },
            { word: "四日", reading: "よっか", meaning: "4th day / four days", kanji: ["四", "日"] },
            { word: "五人", reading: "ごにん", meaning: "five people", kanji: ["五", "人"] },
            { word: "五日", reading: "いつか", meaning: "5th day / five days", kanji: ["五", "日"] },
            { word: "六日", reading: "むいか", meaning: "6th day / six days", kanji: ["六", "日"] },
            { word: "七日", reading: "なのか", meaning: "7th day / seven days", kanji: ["七", "日"] },
            { word: "八日", reading: "ようか", meaning: "8th day / eight days", kanji: ["八", "日"] },
            { word: "九日", reading: "ここのか", meaning: "9th day / nine days", kanji: ["九", "日"] },
            { word: "十日", reading: "とおか", meaning: "10th day / ten days", kanji: ["十", "日"] },
            { word: "百", reading: "ひゃく", meaning: "hundred", kanji: ["百"] },
            { word: "千", reading: "せん", meaning: "thousand", kanji: ["千"] },
            { word: "日本", reading: "にほん", meaning: "Japan", kanji: ["日", "本"] },
            { word: "本", reading: "ほん", meaning: "book", kanji: ["本"] },
            { word: "山", reading: "やま", meaning: "mountain", kanji: ["山"] },
            { word: "川", reading: "かわ", meaning: "river", kanji: ["川"] },
            { word: "火山", reading: "かざん", meaning: "volcano", kanji: ["火", "山"] },
            { word: "水", reading: "みず", meaning: "water", kanji: ["水"] },
            { word: "火", reading: "ひ", meaning: "fire", kanji: ["火"] },
            { word: "木", reading: "き", meaning: "tree", kanji: ["木"] },
            { word: "金", reading: "かね", meaning: "money / gold", kanji: ["金"] },
            { word: "土", reading: "つち", meaning: "earth / soil", kanji: ["土"] },
            { word: "月", reading: "つき", meaning: "moon / month", kanji: ["月"] },
            { word: "日", reading: "ひ", meaning: "sun / day", kanji: ["日"] },
            { word: "空", reading: "そら", meaning: "sky", kanji: ["空"] },
            { word: "雨", reading: "あめ", meaning: "rain", kanji: ["雨"] },
            { word: "花", reading: "はな", meaning: "flower", kanji: ["花"] },
            { word: "草", reading: "くさ", meaning: "grass", kanji: ["草"] },
            { word: "森", reading: "もり", meaning: "forest", kanji: ["森"] },
            { word: "林", reading: "はやし", meaning: "grove / woods", kanji: ["林"] },
            { word: "石", reading: "いし", meaning: "stone", kanji: ["石"] },
            { word: "竹", reading: "たけ", meaning: "bamboo", kanji: ["竹"] },
            { word: "虫", reading: "むし", meaning: "insect", kanji: ["虫"] },
            { word: "貝", reading: "かい", meaning: "shellfish", kanji: ["貝"] },
            { word: "犬", reading: "いぬ", meaning: "dog", kanji: ["犬"] },
            { word: "大きい", reading: "おおきい", meaning: "big", kanji: ["大"] },
            { word: "小さい", reading: "ちいさい", meaning: "small", kanji: ["小"] },
            { word: "上", reading: "うえ", meaning: "above / up", kanji: ["上"] },
            { word: "下", reading: "した", meaning: "below / down", kanji: ["下"] },
            { word: "中", reading: "なか", meaning: "inside / middle", kanji: ["中"] },
            { word: "左", reading: "ひだり", meaning: "left", kanji: ["左"] },
            { word: "右", reading: "みぎ", meaning: "right", kanji: ["右"] },
            { word: "出る", reading: "でる", meaning: "to exit / go out", kanji: ["出"] },
            { word: "入る", reading: "はいる", meaning: "to enter", kanji: ["入"] },
            { word: "見る", reading: "みる", meaning: "to see / look", kanji: ["見"] },
            { word: "手", reading: "て", meaning: "hand", kanji: ["手"] },
            { word: "足", reading: "あし", meaning: "foot / leg", kanji: ["足"] },
            { word: "口", reading: "くち", meaning: "mouth", kanji: ["口"] },
            { word: "耳", reading: "みみ", meaning: "ear", kanji: ["耳"] },
            { word: "目", reading: "め", meaning: "eye", kanji: ["目"] },
            { word: "男", reading: "おとこ", meaning: "man", kanji: ["男"] },
            { word: "女", reading: "おんな", meaning: "woman", kanji: ["女"] },
            { word: "子", reading: "こ", meaning: "child", kanji: ["子"] },
            { word: "男の子", reading: "おとこのこ", meaning: "boy", kanji: ["男", "子"] },
            { word: "女の子", reading: "おんなのこ", meaning: "girl", kanji: ["女", "子"] },
            { word: "人", reading: "ひと", meaning: "person", kanji: ["人"] },
            { word: "名前", reading: "なまえ", meaning: "name", kanji: ["名"] },
            { word: "先生", reading: "せんせい", meaning: "teacher", kanji: ["先", "生"] },
            { word: "生きる", reading: "いきる", meaning: "to live", kanji: ["生"] },
            { word: "学生", reading: "がくせい", meaning: "student", kanji: ["学", "生"] },
            { word: "学校", reading: "がっこう", meaning: "school", kanji: ["学", "校"] },
            { word: "学ぶ", reading: "まなぶ", meaning: "to learn", kanji: ["学"] },
            { word: "文字", reading: "もじ", meaning: "character / letter", kanji: ["文", "字"] },
            { word: "正しい", reading: "ただしい", meaning: "correct", kanji: ["正"] },
            { word: "青い", reading: "あおい", meaning: "blue", kanji: ["青"] },
            { word: "赤い", reading: "あかい", meaning: "red", kanji: ["赤"] },
            { word: "白い", reading: "しろい", meaning: "white", kanji: ["白"] },
            { word: "玉", reading: "たま", meaning: "ball / sphere", kanji: ["玉"] },
            { word: "王", reading: "おう", meaning: "king", kanji: ["王"] },
            { word: "円", reading: "えん", meaning: "yen / circle", kanji: ["円"] },
            { word: "音", reading: "おと", meaning: "sound", kanji: ["音"] },
            { word: "気", reading: "き", meaning: "spirit / energy", kanji: ["気"] },
            { word: "天気", reading: "てんき", meaning: "weather", kanji: ["天", "気"] },
            { word: "休む", reading: "やすむ", meaning: "to rest", kanji: ["休"] },
            { word: "糸", reading: "いと", meaning: "thread", kanji: ["糸"] },
            { word: "車", reading: "くるま", meaning: "car", kanji: ["車"] },
            { word: "年", reading: "とし", meaning: "year", kanji: ["年"] },
            { word: "今年", reading: "ことし", meaning: "this year", kanji: ["年"] },
            { word: "夕方", reading: "ゆうがた", meaning: "evening", kanji: ["夕"] },
            { word: "早い", reading: "はやい", meaning: "early / fast", kanji: ["早"] },
            { word: "町", reading: "まち", meaning: "town", kanji: ["町"] },
            { word: "村", reading: "むら", meaning: "village", kanji: ["村"] },
            { word: "田", reading: "た", meaning: "rice field", kanji: ["田"] },
            { word: "天", reading: "てん", meaning: "heaven / sky", kanji: ["天"] },
            { word: "立つ", reading: "たつ", meaning: "to stand", kanji: ["立"] },
            { word: "力", reading: "ちから", meaning: "power / strength", kanji: ["力"] },
            // Additional Grade 1 - Numbers & Counting
            { word: "二つ", reading: "ふたつ", meaning: "two things", kanji: ["二"] },
            { word: "三つ", reading: "みっつ", meaning: "three things", kanji: ["三"] },
            { word: "四つ", reading: "よっつ", meaning: "four things", kanji: ["四"] },
            { word: "五つ", reading: "いつつ", meaning: "five things", kanji: ["五"] },
            { word: "六つ", reading: "むっつ", meaning: "six things", kanji: ["六"] },
            { word: "七つ", reading: "ななつ", meaning: "seven things", kanji: ["七"] },
            { word: "八つ", reading: "やっつ", meaning: "eight things", kanji: ["八"] },
            { word: "九つ", reading: "ここのつ", meaning: "nine things", kanji: ["九"] },
            { word: "十", reading: "じゅう", meaning: "ten", kanji: ["十"] },
            { word: "一月", reading: "いちがつ", meaning: "January", kanji: ["一", "月"] },
            { word: "二月", reading: "にがつ", meaning: "February", kanji: ["二", "月"] },
            { word: "三月", reading: "さんがつ", meaning: "March", kanji: ["三", "月"] },
            { word: "四月", reading: "しがつ", meaning: "April", kanji: ["四", "月"] },
            { word: "五月", reading: "ごがつ", meaning: "May", kanji: ["五", "月"] },
            { word: "六月", reading: "ろくがつ", meaning: "June", kanji: ["六", "月"] },
            { word: "七月", reading: "しちがつ", meaning: "July", kanji: ["七", "月"] },
            { word: "八月", reading: "はちがつ", meaning: "August", kanji: ["八", "月"] },
            { word: "九月", reading: "くがつ", meaning: "September", kanji: ["九", "月"] },
            { word: "十月", reading: "じゅうがつ", meaning: "October", kanji: ["十", "月"] },
            { word: "十一月", reading: "じゅういちがつ", meaning: "November", kanji: ["十", "一", "月"] },
            { word: "十二月", reading: "じゅうにがつ", meaning: "December", kanji: ["十", "二", "月"] },
            { word: "一万", reading: "いちまん", meaning: "ten thousand", kanji: ["一"] },
            { word: "二百", reading: "にひゃく", meaning: "two hundred", kanji: ["二", "百"] },
            { word: "三百", reading: "さんびゃく", meaning: "three hundred", kanji: ["三", "百"] },
            { word: "六百", reading: "ろっぴゃく", meaning: "six hundred", kanji: ["六", "百"] },
            { word: "八百", reading: "はっぴゃく", meaning: "eight hundred", kanji: ["八", "百"] },
            { word: "三千", reading: "さんぜん", meaning: "three thousand", kanji: ["三", "千"] },
            // Additional Grade 1 - Days & Time
            { word: "日曜日", reading: "にちようび", meaning: "Sunday", kanji: ["日"] },
            { word: "月曜日", reading: "げつようび", meaning: "Monday", kanji: ["月"] },
            { word: "火曜日", reading: "かようび", meaning: "Tuesday", kanji: ["火"] },
            { word: "水曜日", reading: "すいようび", meaning: "Wednesday", kanji: ["水"] },
            { word: "木曜日", reading: "もくようび", meaning: "Thursday", kanji: ["木"] },
            { word: "金曜日", reading: "きんようび", meaning: "Friday", kanji: ["金"] },
            { word: "土曜日", reading: "どようび", meaning: "Saturday", kanji: ["土"] },
            { word: "毎日", reading: "まいにち", meaning: "every day", kanji: ["日"] },
            { word: "来年", reading: "らいねん", meaning: "next year", kanji: ["年"] },
            { word: "去年", reading: "きょねん", meaning: "last year", kanji: ["年"] },
            { word: "一年", reading: "いちねん", meaning: "one year", kanji: ["一", "年"] },
            { word: "半年", reading: "はんとし", meaning: "half a year", kanji: ["年"] },
            { word: "夕日", reading: "ゆうひ", meaning: "sunset", kanji: ["夕", "日"] },
            { word: "夕食", reading: "ゆうしょく", meaning: "dinner", kanji: ["夕"] },
            { word: "天国", reading: "てんごく", meaning: "heaven / paradise", kanji: ["天"] },
            { word: "雨天", reading: "うてん", meaning: "rainy weather", kanji: ["雨", "天"] },
            // Additional Grade 1 - Nature
            { word: "富士山", reading: "ふじさん", meaning: "Mt. Fuji", kanji: ["山"] },
            { word: "山川", reading: "やまかわ", meaning: "mountains and rivers", kanji: ["山", "川"] },
            { word: "大雨", reading: "おおあめ", meaning: "heavy rain", kanji: ["大", "雨"] },
            { word: "空気", reading: "くうき", meaning: "air", kanji: ["空", "気"] },
            { word: "空港", reading: "くうこう", meaning: "airport", kanji: ["空"] },
            { word: "花火", reading: "はなび", meaning: "fireworks", kanji: ["花", "火"] },
            { word: "花見", reading: "はなみ", meaning: "flower viewing", kanji: ["花", "見"] },
            { word: "草原", reading: "そうげん", meaning: "grassland / prairie", kanji: ["草"] },
            { word: "森林", reading: "しんりん", meaning: "forest", kanji: ["森", "林"] },
            { word: "石油", reading: "せきゆ", meaning: "petroleum / oil", kanji: ["石"] },
            { word: "竹林", reading: "ちくりん", meaning: "bamboo grove", kanji: ["竹", "林"] },
            { word: "昆虫", reading: "こんちゅう", meaning: "insect", kanji: ["虫"] },
            { word: "貝殻", reading: "かいがら", meaning: "seashell", kanji: ["貝"] },
            { word: "子犬", reading: "こいぬ", meaning: "puppy", kanji: ["子", "犬"] },
            // Additional Grade 1 - Body & People
            { word: "目的", reading: "もくてき", meaning: "purpose / goal", kanji: ["目"] },
            { word: "注目", reading: "ちゅうもく", meaning: "attention", kanji: ["目"] },
            { word: "耳鳴り", reading: "みみなり", meaning: "ringing in ears", kanji: ["耳"] },
            { word: "入口", reading: "いりぐち", meaning: "entrance", kanji: ["入", "口"] },
            { word: "出口", reading: "でぐち", meaning: "exit", kanji: ["出", "口"] },
            { word: "人口", reading: "じんこう", meaning: "population", kanji: ["人", "口"] },
            { word: "手紙", reading: "てがみ", meaning: "letter", kanji: ["手"] },
            { word: "上手", reading: "じょうず", meaning: "skillful / good at", kanji: ["上", "手"] },
            { word: "下手", reading: "へた", meaning: "unskillful / bad at", kanji: ["下", "手"] },
            { word: "歌手", reading: "かしゅ", meaning: "singer", kanji: ["手"] },
            { word: "足りる", reading: "たりる", meaning: "to be enough", kanji: ["足"] },
            { word: "不足", reading: "ふそく", meaning: "shortage / lack", kanji: ["足"] },
            { word: "日本人", reading: "にほんじん", meaning: "Japanese person", kanji: ["日", "本", "人"] },
            { word: "大人", reading: "おとな", meaning: "adult", kanji: ["大", "人"] },
            { word: "男性", reading: "だんせい", meaning: "male / man", kanji: ["男"] },
            { word: "女性", reading: "じょせい", meaning: "female / woman", kanji: ["女"] },
            { word: "女子", reading: "じょし", meaning: "girl / female", kanji: ["女", "子"] },
            { word: "男子", reading: "だんし", meaning: "boy / male", kanji: ["男", "子"] },
            { word: "子供", reading: "こども", meaning: "child / children", kanji: ["子"] },
            // Additional Grade 1 - Positions & Actions
            { word: "以上", reading: "いじょう", meaning: "more than / above", kanji: ["上"] },
            { word: "上下", reading: "じょうげ", meaning: "up and down", kanji: ["上", "下"] },
            { word: "地下", reading: "ちか", meaning: "underground", kanji: ["下"] },
            { word: "下車", reading: "げしゃ", meaning: "getting off (train)", kanji: ["下", "車"] },
            { word: "中学", reading: "ちゅうがく", meaning: "middle school", kanji: ["中", "学"] },
            { word: "中国", reading: "ちゅうごく", meaning: "China", kanji: ["中"] },
            { word: "左右", reading: "さゆう", meaning: "left and right", kanji: ["左", "右"] },
            { word: "右折", reading: "うせつ", meaning: "right turn", kanji: ["右"] },
            { word: "左折", reading: "させつ", meaning: "left turn", kanji: ["左"] },
            { word: "入学", reading: "にゅうがく", meaning: "school admission", kanji: ["入", "学"] },
            { word: "出発", reading: "しゅっぱつ", meaning: "departure", kanji: ["出"] },
            { word: "外出", reading: "がいしゅつ", meaning: "going out", kanji: ["出"] },
            { word: "見学", reading: "けんがく", meaning: "field trip / observation", kanji: ["見", "学"] },
            { word: "意見", reading: "いけん", meaning: "opinion", kanji: ["見"] },
            { word: "立派", reading: "りっぱ", meaning: "splendid / fine", kanji: ["立"] },
            { word: "国立", reading: "こくりつ", meaning: "national / state-run", kanji: ["立"] },
            // Additional Grade 1 - School & Learning
            { word: "小学校", reading: "しょうがっこう", meaning: "elementary school", kanji: ["小", "学", "校"] },
            { word: "高校", reading: "こうこう", meaning: "high school", kanji: ["校"] },
            { word: "文化", reading: "ぶんか", meaning: "culture", kanji: ["文"] },
            { word: "文章", reading: "ぶんしょう", meaning: "sentence / writing", kanji: ["文"] },
            { word: "数字", reading: "すうじ", meaning: "numeral / digit", kanji: ["字"] },
            { word: "有名", reading: "ゆうめい", meaning: "famous", kanji: ["名"] },
            { word: "名人", reading: "めいじん", meaning: "master / expert", kanji: ["名", "人"] },
            { word: "生活", reading: "せいかつ", meaning: "life / living", kanji: ["生"] },
            { word: "一生", reading: "いっしょう", meaning: "whole life", kanji: ["一", "生"] },
            { word: "誕生日", reading: "たんじょうび", meaning: "birthday", kanji: ["生", "日"] },
            { word: "先週", reading: "せんしゅう", meaning: "last week", kanji: ["先"] },
            { word: "先月", reading: "せんげつ", meaning: "last month", kanji: ["先", "月"] },
            // Additional Grade 1 - Remaining Kanji
            { word: "円い", reading: "まるい", meaning: "round / circular", kanji: ["円"] },
            { word: "百円", reading: "ひゃくえん", meaning: "100 yen", kanji: ["百", "円"] },
            { word: "女王", reading: "じょおう", meaning: "queen", kanji: ["女", "王"] },
            { word: "王様", reading: "おうさま", meaning: "king", kanji: ["王"] },
            { word: "音楽", reading: "おんがく", meaning: "music", kanji: ["音"] },
            { word: "発音", reading: "はつおん", meaning: "pronunciation", kanji: ["音"] },
            { word: "元気", reading: "げんき", meaning: "healthy / energetic", kanji: ["気"] },
            { word: "気分", reading: "きぶん", meaning: "feeling / mood", kanji: ["気"] },
            { word: "人気", reading: "にんき", meaning: "popularity", kanji: ["人", "気"] },
            { word: "休日", reading: "きゅうじつ", meaning: "holiday / day off", kanji: ["休", "日"] },
            { word: "休憩", reading: "きゅうけい", meaning: "break / rest", kanji: ["休"] },
            { word: "目玉", reading: "めだま", meaning: "eyeball", kanji: ["目", "玉"] },
            { word: "電車", reading: "でんしゃ", meaning: "train", kanji: ["車"] },
            { word: "自転車", reading: "じてんしゃ", meaning: "bicycle", kanji: ["車"] },
            { word: "正解", reading: "せいかい", meaning: "correct answer", kanji: ["正"] },
            { word: "正月", reading: "しょうがつ", meaning: "New Year", kanji: ["正", "月"] },
            { word: "青年", reading: "せいねん", meaning: "youth / young person", kanji: ["青", "年"] },
            { word: "赤ちゃん", reading: "あかちゃん", meaning: "baby", kanji: ["赤"] },
            { word: "努力", reading: "どりょく", meaning: "effort", kanji: ["力"] },
            { word: "電力", reading: "でんりょく", meaning: "electric power", kanji: ["力"] },
            { word: "町長", reading: "ちょうちょう", meaning: "town mayor", kanji: ["町"] },
            { word: "農村", reading: "のうそん", meaning: "farming village", kanji: ["村"] },
            { word: "水田", reading: "すいでん", meaning: "rice paddy", kanji: ["水", "田"] },
            { word: "田んぼ", reading: "たんぼ", meaning: "rice field", kanji: ["田"] },
            { word: "早朝", reading: "そうちょう", meaning: "early morning", kanji: ["早"] },
            { word: "大学", reading: "だいがく", meaning: "university", kanji: ["大", "学"] },
            { word: "大切", reading: "たいせつ", meaning: "important / precious", kanji: ["大"] },
            { word: "大好き", reading: "だいすき", meaning: "love / like very much", kanji: ["大"] },
            { word: "白紙", reading: "はくし", meaning: "blank paper", kanji: ["白"] },
            { word: "金魚", reading: "きんぎょ", meaning: "goldfish", kanji: ["金"] },
            { word: "火事", reading: "かじ", meaning: "fire (disaster)", kanji: ["火"] },
            // Grade 2 vocabulary
            { word: "今日", reading: "きょう", meaning: "today", kanji: ["今", "日"] },
            { word: "明日", reading: "あした", meaning: "tomorrow", kanji: ["明", "日"] },
            { word: "友達", reading: "ともだち", meaning: "friend", kanji: ["友"] },
            { word: "父", reading: "ちち", meaning: "father", kanji: ["父"] },
            { word: "母", reading: "はは", meaning: "mother", kanji: ["母"] },
            { word: "兄", reading: "あに", meaning: "older brother", kanji: ["兄"] },
            { word: "姉", reading: "あね", meaning: "older sister", kanji: ["姉"] },
            { word: "弟", reading: "おとうと", meaning: "younger brother", kanji: ["弟"] },
            { word: "妹", reading: "いもうと", meaning: "younger sister", kanji: ["妹"] },
            { word: "家", reading: "いえ", meaning: "house / home", kanji: ["家"] },
            { word: "門", reading: "もん", meaning: "gate", kanji: ["門"] },
            { word: "店", reading: "みせ", meaning: "shop / store", kanji: ["店"] },
            { word: "電話", reading: "でんわ", meaning: "telephone", kanji: ["電", "話"] },
            { word: "歩く", reading: "あるく", meaning: "to walk", kanji: ["歩"] },
            { word: "走る", reading: "はしる", meaning: "to run", kanji: ["走"] },
            { word: "買う", reading: "かう", meaning: "to buy", kanji: ["買"] },
            { word: "売る", reading: "うる", meaning: "to sell", kanji: ["売"] },
            { word: "食べる", reading: "たべる", meaning: "to eat", kanji: ["食"] },
            { word: "飲む", reading: "のむ", meaning: "to drink", kanji: ["飲"] },
            { word: "読む", reading: "よむ", meaning: "to read", kanji: ["読"] },
            { word: "書く", reading: "かく", meaning: "to write", kanji: ["書"] },
            { word: "聞く", reading: "きく", meaning: "to hear / ask", kanji: ["聞"] },
            { word: "話す", reading: "はなす", meaning: "to speak", kanji: ["話"] },
            { word: "言う", reading: "いう", meaning: "to say", kanji: ["言"] },
            { word: "考える", reading: "かんがえる", meaning: "to think", kanji: ["考"] },
            { word: "知る", reading: "しる", meaning: "to know", kanji: ["知"] },
            { word: "思う", reading: "おもう", meaning: "to think / feel", kanji: ["思"] },
            { word: "会う", reading: "あう", meaning: "to meet", kanji: ["会"] },
            { word: "帰る", reading: "かえる", meaning: "to return home", kanji: ["帰"] },
            { word: "来る", reading: "くる", meaning: "to come", kanji: ["来"] },
            { word: "行く", reading: "いく", meaning: "to go", kanji: ["行"] },
            { word: "時間", reading: "じかん", meaning: "time", kanji: ["時", "間"] },
            { word: "朝", reading: "あさ", meaning: "morning", kanji: ["朝"] },
            { word: "昼", reading: "ひる", meaning: "noon / daytime", kanji: ["昼"] },
            { word: "夜", reading: "よる", meaning: "night", kanji: ["夜"] },
            { word: "春", reading: "はる", meaning: "spring", kanji: ["春"] },
            { word: "夏", reading: "なつ", meaning: "summer", kanji: ["夏"] },
            { word: "秋", reading: "あき", meaning: "autumn", kanji: ["秋"] },
            { word: "冬", reading: "ふゆ", meaning: "winter", kanji: ["冬"] },
            { word: "東", reading: "ひがし", meaning: "east", kanji: ["東"] },
            { word: "西", reading: "にし", meaning: "west", kanji: ["西"] },
            { word: "南", reading: "みなみ", meaning: "south", kanji: ["南"] },
            { word: "北", reading: "きた", meaning: "north", kanji: ["北"] },
            { word: "海", reading: "うみ", meaning: "sea / ocean", kanji: ["海"] },
            { word: "魚", reading: "さかな", meaning: "fish", kanji: ["魚"] },
            { word: "鳥", reading: "とり", meaning: "bird", kanji: ["鳥"] },
            { word: "馬", reading: "うま", meaning: "horse", kanji: ["馬"] },
            { word: "牛", reading: "うし", meaning: "cow", kanji: ["牛"] },
            { word: "雪", reading: "ゆき", meaning: "snow", kanji: ["雪"] },
            { word: "雲", reading: "くも", meaning: "cloud", kanji: ["雲"] },
            { word: "風", reading: "かぜ", meaning: "wind", kanji: ["風"] },
            { word: "星", reading: "ほし", meaning: "star", kanji: ["星"] },
            { word: "高い", reading: "たかい", meaning: "high / expensive", kanji: ["高"] },
            { word: "長い", reading: "ながい", meaning: "long", kanji: ["長"] },
            { word: "弱い", reading: "よわい", meaning: "weak", kanji: ["弱"] },
            { word: "強い", reading: "つよい", meaning: "strong", kanji: ["強"] },
            { word: "黒い", reading: "くろい", meaning: "black", kanji: ["黒"] },
            { word: "黄色い", reading: "きいろい", meaning: "yellow", kanji: ["黄", "色"] },
            { word: "新しい", reading: "あたらしい", meaning: "new", kanji: ["新"] },
            { word: "古い", reading: "ふるい", meaning: "old (things)", kanji: ["古"] },
            { word: "近い", reading: "ちかい", meaning: "near", kanji: ["近"] },
            { word: "遠い", reading: "とおい", meaning: "far", kanji: ["遠"] },
            { word: "多い", reading: "おおい", meaning: "many", kanji: ["多"] },
            { word: "少ない", reading: "すくない", meaning: "few", kanji: ["少"] },
            { word: "広い", reading: "ひろい", meaning: "wide / spacious", kanji: ["広"] },
            { word: "楽しい", reading: "たのしい", meaning: "fun / enjoyable", kanji: ["楽"] },
            { word: "茶", reading: "ちゃ", meaning: "tea", kanji: ["茶"] },
            { word: "米", reading: "こめ", meaning: "rice (uncooked)", kanji: ["米"] },
            { word: "肉", reading: "にく", meaning: "meat", kanji: ["肉"] },
            { word: "絵", reading: "え", meaning: "picture / painting", kanji: ["絵"] },
            { word: "歌", reading: "うた", meaning: "song", kanji: ["歌"] },
            { word: "歌う", reading: "うたう", meaning: "to sing", kanji: ["歌"] },
            { word: "答える", reading: "こたえる", meaning: "to answer", kanji: ["答"] },
            { word: "道", reading: "みち", meaning: "road / path", kanji: ["道"] },
            { word: "京都", reading: "きょうと", meaning: "Kyoto", kanji: ["京"] },
            { word: "東京", reading: "とうきょう", meaning: "Tokyo", kanji: ["東", "京"] },
            { word: "国", reading: "くに", meaning: "country", kanji: ["国"] },
            { word: "外国", reading: "がいこく", meaning: "foreign country", kanji: ["外", "国"] },
            // Grade 3+ vocabulary
            { word: "世界", reading: "せかい", meaning: "world", kanji: ["世", "界"] },
            { word: "仕事", reading: "しごと", meaning: "work / job", kanji: ["仕", "事"] },
            { word: "勉強", reading: "べんきょう", meaning: "study", kanji: ["勉", "強"] },
            { word: "練習", reading: "れんしゅう", meaning: "practice", kanji: ["練", "習"] },
            { word: "旅行", reading: "りょこう", meaning: "travel / trip", kanji: ["旅", "行"] },
            { word: "病院", reading: "びょういん", meaning: "hospital", kanji: ["病", "院"] },
            { word: "銀行", reading: "ぎんこう", meaning: "bank", kanji: ["銀", "行"] },
            { word: "駅", reading: "えき", meaning: "train station", kanji: ["駅"] },
            { word: "映画", reading: "えいが", meaning: "movie", kanji: ["映", "画"] },
            { word: "写真", reading: "しゃしん", meaning: "photograph", kanji: ["写", "真"] },
            { word: "問題", reading: "もんだい", meaning: "problem / question", kanji: ["問", "題"] },
            { word: "意味", reading: "いみ", meaning: "meaning", kanji: ["意", "味"] },
            { word: "感じ", reading: "かんじ", meaning: "feeling / kanji", kanji: ["感"] },
            { word: "漢字", reading: "かんじ", meaning: "kanji", kanji: ["漢", "字"] },
            { word: "運動", reading: "うんどう", meaning: "exercise / sports", kanji: ["運", "動"] },
            { word: "野菜", reading: "やさい", meaning: "vegetables", kanji: ["野", "菜"] }
        ];

        // Kanji Readings Database - on'yomi and kun'yomi for all 1,026 kanji
        // Format: kanji -> [most common readings]
        const KANJI_READINGS = {
            // Grade 1 (80 kanji)
            "一": ["いち", "いつ", "ひと"], "右": ["みぎ", "う", "ゆう"], "雨": ["あめ", "あま", "う"],
            "円": ["えん", "まる"], "王": ["おう"], "音": ["おと", "おん", "いん"],
            "下": ["した", "しも", "もと", "さ", "くだ", "お", "か", "げ"],
            "火": ["ひ", "か"], "花": ["はな", "か"], "貝": ["かい"],
            "学": ["がく", "まな"], "気": ["き", "け"], "九": ["きゅう", "く", "ここの"],
            "休": ["やす", "きゅう"], "玉": ["たま", "ぎょく"], "金": ["かね", "きん", "こん"],
            "空": ["そら", "あ", "から", "くう"], "月": ["つき", "げつ", "がつ"],
            "犬": ["いぬ", "けん"], "見": ["み", "けん"], "五": ["ご", "いつ"],
            "口": ["くち", "こう", "く"], "校": ["こう"], "左": ["ひだり", "さ"],
            "三": ["さん", "み", "みっ"], "山": ["やま", "さん"], "子": ["こ", "し", "す"],
            "四": ["し", "よ", "よん", "よっ"], "糸": ["いと", "し"], "字": ["じ", "あざ"],
            "耳": ["みみ", "じ"], "七": ["しち", "なな", "なの"], "車": ["くるま", "しゃ"],
            "手": ["て", "しゅ"], "十": ["じゅう", "とお", "と"], "出": ["で", "だ", "しゅつ", "すい"],
            "女": ["おんな", "め", "じょ", "にょ"], "小": ["ちい", "こ", "お", "しょう"],
            "上": ["うえ", "うわ", "かみ", "あ", "のぼ", "じょう", "しょう"],
            "森": ["もり", "しん"], "人": ["ひと", "じん", "にん"], "水": ["みず", "すい"],
            "正": ["ただ", "まさ", "せい", "しょう"], "生": ["い", "う", "は", "き", "なま", "せい", "しょう"],
            "青": ["あお", "せい", "しょう"], "夕": ["ゆう"], "石": ["いし", "せき", "しゃく", "こく"],
            "赤": ["あか", "せき", "しゃく"], "千": ["せん", "ち"], "川": ["かわ", "せん"],
            "先": ["さき", "せん"], "早": ["はや", "さ", "そう"], "草": ["くさ", "そう"],
            "足": ["あし", "た", "そく"], "村": ["むら", "そん"], "大": ["おお", "だい", "たい"],
            "男": ["おとこ", "だん", "なん"], "竹": ["たけ", "ちく"], "中": ["なか", "ちゅう", "じゅう"],
            "虫": ["むし", "ちゅう"], "町": ["まち", "ちょう"], "天": ["てん", "あめ", "あま"],
            "田": ["た", "でん"], "土": ["つち", "と", "ど"], "二": ["に", "ふた"],
            "日": ["ひ", "び", "か", "にち", "じつ"], "入": ["はい", "い", "にゅう"],
            "年": ["とし", "ねん"], "白": ["しろ", "しら", "はく", "びゃく"],
            "八": ["はち", "や", "やっ", "よう"], "百": ["ひゃく", "びゃく", "もも"],
            "文": ["ぶん", "もん", "ふみ"], "木": ["き", "こ", "もく", "ぼく"],
            "本": ["もと", "ほん"], "名": ["な", "めい", "みょう"], "目": ["め", "もく", "ぼく"],
            "立": ["た", "りつ", "りゅう"], "力": ["ちから", "りょく", "りき"],
            "林": ["はやし", "りん"], "六": ["ろく", "む", "むっ", "むい"],
            // Grade 2 (160 kanji)
            "刀": ["かたな", "とう"], "丸": ["まる", "がん"], "弓": ["ゆみ", "きゅう"],
            "工": ["こう", "く"], "才": ["さい"], "万": ["まん", "ばん"],
            "引": ["ひ", "いん"], "牛": ["うし", "ぎゅう"], "元": ["もと", "げん", "がん"],
            "戸": ["と", "こ"], "午": ["ご"], "公": ["こう", "おおやけ"],
            "今": ["いま", "こん", "きん"], "止": ["と", "や", "し"], "少": ["すく", "すこ", "しょう"],
            "心": ["こころ", "しん"], "切": ["き", "せつ", "さい"], "太": ["ふと", "たい", "た"],
            "内": ["うち", "ない", "だい"], "父": ["ちち", "ふ"], "分": ["わ", "ぶん", "ふん", "ぶ"],
            "方": ["かた", "ほう"], "毛": ["け", "もう"], "友": ["とも", "ゆう"],
            "外": ["そと", "ほか", "はず", "がい", "げ"], "兄": ["あに", "きょう", "けい"],
            "古": ["ふる", "こ"], "広": ["ひろ", "こう"], "市": ["いち", "し"],
            "矢": ["や", "し"], "台": ["だい", "たい"], "冬": ["ふゆ", "とう"],
            "半": ["はん", "なか"], "母": ["はは", "かあ", "ぼ"], "北": ["きた", "ほく", "ほっ"],
            "用": ["もち", "よう"], "羽": ["はね", "は", "う"], "回": ["まわ", "かい"],
            "会": ["あ", "かい", "え"], "交": ["まじ", "ま", "こう"], "光": ["ひかり", "ひか", "こう"],
            "考": ["かんが", "こう"], "行": ["い", "ゆ", "おこな", "こう", "ぎょう", "あん"],
            "合": ["あ", "あわ", "ごう", "がっ", "かっ"], "寺": ["てら", "じ"],
            "自": ["みずか", "じ", "し"], "色": ["いろ", "しき", "しょく"],
            "西": ["にし", "せい", "さい"], "多": ["おお", "た"], "地": ["ち", "じ"],
            "池": ["いけ", "ち"], "当": ["あ", "とう"], "同": ["おな", "どう"],
            "肉": ["にく"], "米": ["こめ", "べい", "まい"], "毎": ["まい", "ごと"],
            "何": ["なに", "なん", "か"], "角": ["かど", "つの", "かく"], "汽": ["き"],
            "近": ["ちか", "きん", "こん"], "形": ["かたち", "かた", "けい", "ぎょう"],
            "言": ["い", "こと", "げん", "ごん"], "谷": ["たに", "こく"],
            "作": ["つく", "さく", "さ"], "社": ["やしろ", "しゃ"], "図": ["ず", "と", "はか"],
            "声": ["こえ", "せい", "しょう"], "走": ["はし", "そう"], "体": ["からだ", "たい", "てい"],
            "弟": ["おとうと", "てい", "だい", "で"], "売": ["う", "ばい"], "麦": ["むぎ", "ばく"],
            "来": ["く", "き", "こ", "らい"], "里": ["さと", "り"], "画": ["が", "かく", "えが"],
            "岩": ["いわ", "がん"], "京": ["きょう", "けい", "きん"], "国": ["くに", "こく"],
            "姉": ["あね", "し"], "知": ["し", "ち"], "長": ["なが", "ちょう"],
            "直": ["ただ", "なお", "す", "じき", "ちょく"], "店": ["みせ", "てん"],
            "東": ["ひがし", "とう"], "歩": ["ある", "あゆ", "ほ", "ぶ", "ふ"],
            "妹": ["いもうと", "まい"], "明": ["あか", "あき", "めい", "みょう"],
            "門": ["かど", "もん"], "夜": ["よる", "よ", "や"], "科": ["か"],
            "海": ["うみ", "かい"], "活": ["かつ", "い"], "計": ["はか", "けい"],
            "後": ["あと", "うし", "のち", "おく", "ご", "こう"], "思": ["おも", "し"],
            "室": ["むろ", "しつ"], "首": ["くび", "しゅ"], "秋": ["あき", "しゅう"],
            "春": ["はる", "しゅん"], "食": ["た", "く", "しょく", "じき"],
            "星": ["ほし", "せい", "しょう"], "前": ["まえ", "ぜん"], "茶": ["ちゃ", "さ"],
            "昼": ["ひる", "ちゅう"], "点": ["てん"], "南": ["みなみ", "なん", "な"],
            "風": ["かぜ", "かざ", "ふう", "ふ"], "夏": ["なつ", "か", "げ"],
            "家": ["いえ", "や", "うち", "か", "け"], "記": ["しる", "き"],
            "帰": ["かえ", "き"], "原": ["はら", "げん", "がん"], "高": ["たか", "こう"],
            "紙": ["かみ", "し"], "時": ["とき", "じ"], "弱": ["よわ", "じゃく"],
            "書": ["か", "しょ"], "通": ["とお", "かよ", "つう"], "馬": ["うま", "ま", "ば"],
            "魚": ["さかな", "うお", "ぎょ"], "強": ["つよ", "し", "きょう", "ごう"],
            "教": ["おし", "おそ", "きょう"], "黄": ["き", "こ", "おう"],
            "黒": ["くろ", "こく"], "細": ["ほそ", "こま", "さい"], "週": ["しゅう"],
            "雪": ["ゆき", "せつ"], "船": ["ふね", "ふな", "せん"], "組": ["く", "くみ", "そ"],
            "鳥": ["とり", "ちょう"], "野": ["の", "や"], "理": ["り", "ことわり"],
            "雲": ["くも", "うん"], "絵": ["え", "かい"], "間": ["あいだ", "ま", "かん", "けん"],
            "場": ["ば", "じょう"], "晴": ["は", "せい"], "朝": ["あさ", "ちょう"],
            "答": ["こた", "とう"], "道": ["みち", "どう", "とう"], "買": ["か", "ばい"],
            "番": ["ばん", "つが"], "園": ["その", "えん"], "遠": ["とお", "えん", "おん"],
            "楽": ["たの", "らく", "がく"], "新": ["あたら", "あら", "にい", "しん"],
            "数": ["かず", "かぞ", "すう", "す"], "電": ["でん"], "話": ["はなし", "はな", "わ"],
            "歌": ["うた", "うた", "か"], "語": ["かた", "ご"], "算": ["さん"],
            "読": ["よ", "どく", "とく", "とう"], "聞": ["き", "ぶん", "もん"],
            "鳴": ["な", "めい"], "線": ["せん"], "親": ["おや", "した", "しん"],
            "頭": ["あたま", "かしら", "とう", "ず"], "顔": ["かお", "がん"], "曜": ["よう"],
            // Grade 3 (200 kanji)
            "丁": ["ちょう", "てい"], "化": ["ば", "か", "け"], "区": ["く"],
            "反": ["そ", "はん", "たん", "ほん"], "予": ["よ"], "央": ["おう"],
            "去": ["さ", "こ", "きょ"], "号": ["ごう"], "皿": ["さら"],
            "仕": ["つか", "し", "じ"], "写": ["うつ", "しゃ"], "主": ["ぬし", "おも", "しゅ", "す"],
            "申": ["もう", "しん"], "世": ["よ", "せ", "せい"], "他": ["ほか", "た"],
            "打": ["う", "だ"], "代": ["か", "だい", "たい"], "皮": ["かわ", "ひ"],
            "氷": ["こおり", "ひ", "ひょう"], "平": ["たい", "ひら", "へい", "びょう"],
            "由": ["よし", "ゆ", "ゆう", "ゆい"], "礼": ["れい", "らい"],
            "安": ["やす", "あん"], "曲": ["ま", "きょく"], "血": ["ち", "けつ"],
            "向": ["む", "こう"], "死": ["し"], "次": ["つ", "じ", "し"],
            "式": ["しき"], "守": ["まも", "も", "しゅ", "す"], "州": ["す", "しゅう"],
            "全": ["まった", "ぜん"], "有": ["あ", "ゆう", "う"], "羊": ["ひつじ", "よう"],
            "両": ["りょう"], "列": ["れつ"], "医": ["い"],
            "究": ["きわ", "きゅう"], "局": ["きょく"], "君": ["きみ", "くん"],
            "決": ["き", "けつ"], "住": ["す", "じゅう"], "助": ["たす", "すけ", "じょ"],
            "身": ["み", "しん"], "対": ["たい", "つい"], "投": ["な", "とう"],
            "豆": ["まめ", "とう", "ず"], "坂": ["さか", "はん"], "返": ["かえ", "へん"],
            "役": ["やく", "えき"], "委": ["い"], "育": ["そだ", "いく"],
            "泳": ["およ", "えい"], "岸": ["きし", "がん"], "苦": ["くる", "にが", "く"],
            "具": ["ぐ"], "幸": ["さいわ", "しあわ", "こう"], "使": ["つか", "し"],
            "始": ["はじ", "し"], "事": ["こと", "じ", "ず"], "実": ["み", "みの", "じつ"],
            "者": ["もの", "しゃ"], "取": ["と", "しゅ"], "受": ["う", "じゅ"],
            "所": ["ところ", "しょ"], "昔": ["むかし", "せき", "しゃく"],
            "注": ["そそ", "ちゅう"], "定": ["さだ", "てい", "じょう"],
            "波": ["なみ", "は"], "板": ["いた", "ばん", "はん"], "表": ["あらわ", "おもて", "ひょう"],
            "服": ["ふく"], "物": ["もの", "ぶつ", "もつ"], "放": ["はな", "ほう"],
            "味": ["あじ", "み"], "命": ["いのち", "めい", "みょう"], "油": ["あぶら", "ゆ"],
            "和": ["やわ", "なご", "わ", "お"], "屋": ["や", "おく"],
            "界": ["かい"], "客": ["きゃく", "かく"], "急": ["いそ", "きゅう"],
            "級": ["きゅう"], "係": ["かかり", "かか", "けい"], "研": ["と", "けん"],
            "県": ["けん"], "指": ["ゆび", "さ", "し"], "持": ["も", "じ"],
            "拾": ["ひろ", "しゅう", "じゅう"], "重": ["おも", "かさ", "え", "じゅう", "ちょう"],
            "昭": ["しょう"], "乗": ["の", "じょう"], "神": ["かみ", "かん", "こう", "しん", "じん"],
            "相": ["あい", "そう", "しょう"], "送": ["おく", "そう"],
            "待": ["ま", "たい"], "炭": ["すみ", "たん"], "柱": ["はしら", "ちゅう"],
            "追": ["お", "つい"], "度": ["たび", "ど", "と"], "畑": ["はた", "はたけ"],
            "発": ["はつ", "ほつ"], "美": ["うつく", "び", "み"], "秒": ["びょう"],
            "品": ["しな", "ひん"], "負": ["ま", "お", "ふ"], "面": ["おも", "おもて", "めん"],
            "洋": ["よう"], "員": ["いん"], "院": ["いん"], "荷": ["に", "か"],
            "起": ["お", "き"], "宮": ["みや", "きゅう", "ぐう"], "庫": ["こ", "く"],
            "根": ["ね", "こん"], "酒": ["さけ", "さか", "しゅ"], "消": ["き", "け", "しょう"],
            "真": ["ま", "しん"], "息": ["いき", "そく"], "速": ["はや", "すみ", "そく"],
            "庭": ["にわ", "てい"], "島": ["しま", "とう"], "配": ["くば", "はい"],
            "倍": ["ばい"], "病": ["やまい", "びょう", "へい"], "勉": ["べん"],
            "流": ["なが", "りゅう", "る"], "旅": ["たび", "りょ"],
            "悪": ["わる", "あく", "お"], "球": ["きゅう", "たま"], "祭": ["まつ", "さい"],
            "終": ["お", "しゅう"], "習": ["なら", "しゅう"], "宿": ["やど", "しゅく"],
            "商": ["あきな", "しょう"], "章": ["しょう"], "深": ["ふか", "しん"],
            "進": ["すす", "しん"], "族": ["ぞく"], "第": ["だい"],
            "帳": ["ちょう"], "笛": ["ふえ", "てき"], "転": ["ころ", "てん"],
            "都": ["みやこ", "と", "つ"], "動": ["うご", "どう"], "部": ["ぶ"],
            "問": ["と", "もん"], "飲": ["の", "いん"], "運": ["はこ", "うん"],
            "温": ["あたた", "おん"], "開": ["ひら", "あ", "かい"], "階": ["かい"],
            "寒": ["さむ", "かん"], "期": ["き", "ご"], "軽": ["かる", "かろ", "けい"],
            "湖": ["みずうみ", "こ"], "港": ["みなと", "こう"], "歯": ["は", "し"],
            "集": ["あつ", "しゅう"], "暑": ["あつ", "しょ"], "勝": ["か", "まさ", "しょう"],
            "植": ["う", "しょく"], "短": ["みじか", "たん"], "着": ["き", "つ", "ちゃく", "じゃく"],
            "湯": ["ゆ", "とう"], "登": ["のぼ", "と", "とう"], "等": ["ひと", "とう"],
            "童": ["わらべ", "どう"], "悲": ["かな", "ひ"], "筆": ["ふで", "ひつ"],
            "遊": ["あそ", "ゆう", "ゆ"], "葉": ["は", "よう"], "陽": ["ひ", "よう"],
            "落": ["お", "らく"], "暗": ["くら", "あん"], "意": ["い"],
            "感": ["かん"], "漢": ["かん"], "業": ["わざ", "ぎょう", "ごう"],
            "詩": ["し"], "想": ["そう", "そ"], "鉄": ["てつ"],
            "農": ["のう"], "福": ["ふく"], "路": ["じ", "ろ"],
            "駅": ["えき"], "銀": ["ぎん"], "鼻": ["はな", "び"],
            "様": ["さま", "よう"], "緑": ["みどり", "りょく", "ろく"], "練": ["ね", "れん"],
            "横": ["よこ", "おう"], "談": ["だん"], "調": ["しら", "ととの", "ちょう"],
            "箱": ["はこ"], "館": ["かん", "やかた"], "橋": ["はし", "きょう"],
            "整": ["ととの", "せい"], "薬": ["くすり", "やく"], "題": ["だい"],
            // Grade 4 (202 kanji)
            "欠": ["か", "けつ"], "氏": ["うじ", "し"], "井": ["い", "せい", "しょう"],
            "不": ["ふ", "ぶ"], "夫": ["おっと", "ふう", "ふ"], "以": ["い", "もっ"],
            "加": ["くわ", "か"], "功": ["こう", "く"], "札": ["ふだ", "さつ"],
            "司": ["し"], "失": ["うしな", "しつ"], "必": ["かなら", "ひつ"],
            "付": ["つ", "ふ"], "辺": ["あた", "へん"], "包": ["つつ", "ほう"],
            "末": ["すえ", "まつ", "ばつ"], "未": ["いま", "み", "び"], "民": ["たみ", "みん"],
            "令": ["れい", "りょう"], "衣": ["ころも", "い", "え"], "印": ["しるし", "いん"],
            "各": ["おのおの", "かく"], "共": ["とも", "きょう"], "好": ["す", "この", "こう"],
            "成": ["な", "せい", "じょう"], "争": ["あらそ", "そう"], "仲": ["なか", "ちゅう"],
            "兆": ["きざ", "ちょう"], "伝": ["つた", "でん", "てん"], "灯": ["ひ", "とう"],
            "老": ["お", "ふ", "ろう"], "位": ["くらい", "い"], "改": ["あらた", "かい"],
            "完": ["かん"], "岐": ["き"], "希": ["き", "け"],
            "求": ["もと", "きゅう"], "芸": ["げい"], "佐": ["さ"],
            "材": ["ざい"], "児": ["こ", "じ", "に"], "初": ["はじ", "はつ", "うい", "そ", "しょ"],
            "臣": ["しん", "じん"], "折": ["お", "おり", "せつ"], "束": ["たば", "そく"],
            "沖": ["おき", "ちゅう"], "低": ["ひく", "てい"], "努": ["つと", "ど"],
            "阪": ["はん"], "兵": ["へい", "ひょう"], "別": ["わか", "べつ"],
            "利": ["き", "り"], "良": ["よ", "りょう"], "冷": ["つめ", "ひ", "さ", "れい"],
            "労": ["ろう"], "英": ["えい"], "岡": ["おか"],
            "果": ["は", "くだ", "か"], "芽": ["め", "が"], "官": ["かん"],
            "季": ["き"], "泣": ["な", "きゅう"], "協": ["きょう"],
            "径": ["けい"], "固": ["かた", "こ"], "刷": ["す", "さつ"],
            "参": ["まい", "さん"], "治": ["おさ", "なお", "じ", "ち"], "周": ["まわ", "しゅう"],
            "松": ["まつ", "しょう"], "卒": ["そつ"], "底": ["そこ", "てい"],
            "的": ["まと", "てき"], "典": ["てん"], "奈": ["な"],
            "念": ["ねん"], "府": ["ふ"], "阜": ["ふ"],
            "法": ["のり", "ほう", "はっ", "ほっ"], "牧": ["まき", "ぼく"], "例": ["たと", "れい"],
            "茨": ["いばら", "し"], "栄": ["さか", "は", "えい"], "軍": ["ぐん"],
            "建": ["た", "けん", "こん"], "香": ["か", "かお", "こう", "きょう"],
            "昨": ["さく"], "祝": ["いわ", "しゅく", "しゅう"], "城": ["しろ", "じょう"],
            "信": ["しん"], "省": ["かえり", "はぶ", "せい", "しょう"],
            "浅": ["あさ", "せん"], "単": ["たん"], "栃": ["とち"],
            "飛": ["と", "ひ"], "変": ["か", "へん"], "便": ["たよ", "べん", "びん"],
            "約": ["やく"], "勇": ["いさ", "ゆう"], "要": ["い", "かなめ", "よう"],
            "案": ["あん"], "害": ["がい"], "挙": ["あ", "きょ"],
            "訓": ["くん"], "郡": ["ぐん", "こおり"], "候": ["そうろう", "こう"],
            "差": ["さ", "さす"], "残": ["のこ", "ざん"], "借": ["か", "しゃく"],
            "笑": ["わら", "え", "しょう"], "席": ["せき"], "倉": ["くら", "そう"],
            "孫": ["まご", "そん"], "帯": ["お", "おび", "たい"], "徒": ["と"],
            "特": ["とく"], "梅": ["うめ", "ばい"], "浴": ["あ", "よく"],
            "料": ["りょう"], "連": ["つら", "つ", "れん"], "貨": ["か"],
            "械": ["かい"], "健": ["すこ", "けん"], "康": ["こう"],
            "菜": ["な", "さい"], "埼": ["さい"], "崎": ["さき", "き"],
            "産": ["う", "さん"], "鹿": ["しか", "ろく"], "唱": ["とな", "しょう"],
            "清": ["きよ", "せい", "しょう"], "巣": ["す", "そう"], "側": ["かわ", "がわ", "そく"],
            "梨": ["なし", "り"], "敗": ["やぶ", "はい"], "票": ["ひょう"],
            "副": ["ふく"], "望": ["のぞ", "もち", "ぼう", "もう"], "陸": ["りく", "ろく"],
            "媛": ["ひめ", "えん"], "賀": ["が"], "街": ["まち", "がい", "かい"],
            "覚": ["おぼ", "さ", "かく"], "給": ["きゅう"], "極": ["きわ", "きょく", "ごく"],
            "景": ["けい"], "結": ["むす", "ゆ", "けつ"], "最": ["もっと", "さい"],
            "散": ["ち", "さん"], "滋": ["じ", "し"], "順": ["じゅん"],
            "焼": ["や", "しょう"], "然": ["ねん", "ぜん"], "隊": ["たい"],
            "達": ["たつ", "たち", "だち"], "博": ["はく", "ばく"], "飯": ["めし", "はん"],
            "富": ["と", "とみ", "ふ", "ふう"], "満": ["み", "まん"], "無": ["な", "む", "ぶ"],
            "量": ["はか", "りょう"], "愛": ["あい"], "塩": ["しお", "えん"],
            "群": ["む", "ぐん"], "試": ["ため", "こころ", "し"], "辞": ["や", "じ"],
            "照": ["て", "しょう"], "節": ["ふし", "せつ", "せち"],
            "戦": ["いくさ", "たたか", "せん"], "続": ["つづ", "ぞく"],
            "置": ["お", "ち"], "働": ["はたら", "どう"], "管": ["くだ", "かん"],
            "関": ["せき", "かん"], "旗": ["はた", "き"], "漁": ["りょう", "ぎょ"],
            "熊": ["くま", "ゆう"], "察": ["さつ"], "種": ["たね", "しゅ"],
            "静": ["しず", "せい", "じょう"], "説": ["と", "せつ", "ぜい"],
            "徳": ["とく"], "億": ["おく"], "課": ["か"],
            "潟": ["かた"], "器": ["うつわ", "き"], "縄": ["なわ", "じょう"],
            "選": ["えら", "せん"], "熱": ["あつ", "ねつ"], "標": ["ひょう"],
            "養": ["やしな", "よう"], "輪": ["わ", "りん"], "機": ["はた", "き"],
            "積": ["つ", "せき"], "録": ["ろく"], "観": ["かん"],
            "験": ["けん", "げん"], "類": ["たぐ", "るい"], "願": ["ねが", "がん"],
            "鏡": ["かがみ", "きょう"], "議": ["ぎ"], "競": ["きそ", "きょう", "けい"],
            // Grade 5 (193 kanji)
            "久": ["ひさ", "きゅう", "く"], "士": ["し"], "支": ["ささ", "し"],
            "比": ["くら", "ひ"], "仏": ["ほとけ", "ぶつ", "ふつ"], "圧": ["あつ"],
            "永": ["なが", "えい"], "可": ["か"], "刊": ["かん"],
            "旧": ["ふる", "きゅう"], "句": ["く"], "史": ["し"],
            "示": ["しめ", "じ", "し"], "犯": ["おか", "はん"], "布": ["ぬの", "ふ"],
            "弁": ["べん"], "因": ["よ", "いん"], "仮": ["かり", "か", "け"],
            "件": ["けん"], "再": ["ふたた", "さい", "さ"], "在": ["あ", "ざい"],
            "団": ["だん", "とん"], "任": ["まか", "にん"], "囲": ["かこ", "い"],
            "応": ["おう"], "快": ["こころよ", "かい"], "技": ["わざ", "ぎ"],
            "均": ["きん"], "告": ["つ", "こく"], "災": ["わざわ", "さい"],
            "志": ["こころざ", "し"], "似": ["に", "じ"], "序": ["じょ"],
            "条": ["じょう"], "状": ["じょう"], "判": ["わか", "はん", "ばん"],
            "防": ["ふせ", "ぼう"], "余": ["あま", "よ"], "易": ["やさ", "い", "えき"],
            "往": ["おう"], "価": ["あたい", "か"], "河": ["かわ", "か"],
            "居": ["い", "きょ"], "効": ["き", "こう"], "妻": ["つま", "さい"],
            "枝": ["えだ", "し"], "舎": ["しゃ"], "述": ["の", "じゅつ"],
            "招": ["まね", "しょう"], "制": ["せい"], "性": ["さが", "せい", "しょう"],
            "毒": ["どく"], "版": ["はん"], "肥": ["こ", "ひ"],
            "非": ["ひ"], "武": ["たけ", "ぶ", "む"], "紀": ["き"],
            "逆": ["さか", "ぎゃく", "げき"], "型": ["かた", "けい"], "限": ["かぎ", "げん"],
            "故": ["ゆえ", "こ"], "厚": ["あつ", "こう"], "査": ["さ"],
            "政": ["まつりごと", "せい", "しょう"], "祖": ["そ"], "則": ["そく"],
            "独": ["ひと", "どく"], "保": ["たも", "ほ"], "迷": ["まよ", "めい"],
            "益": ["えき", "やく"], "桜": ["さくら", "おう"], "格": ["かく", "こう"],
            "個": ["こ", "か"], "耕": ["たがや", "こう"], "航": ["こう"],
            "財": ["ざい", "さい"], "殺": ["ころ", "さつ", "さい", "せつ"],
            "師": ["し"], "修": ["おさ", "しゅう", "しゅ"], "素": ["もと", "そ", "す"],
            "造": ["つく", "ぞう"], "能": ["のう"], "破": ["やぶ", "は"],
            "粉": ["こ", "こな", "ふん"], "脈": ["みゃく"], "容": ["よう"],
            "留": ["と", "とど", "りゅう", "る"], "移": ["うつ", "い"],
            "液": ["えき"], "眼": ["まなこ", "め", "がん", "げん"], "基": ["もと", "き"],
            "寄": ["よ", "き"], "規": ["き"], "救": ["すく", "きゅう"],
            "許": ["ゆる", "きょ"], "経": ["へ", "た", "けい", "きょう"],
            "険": ["けわ", "けん"], "現": ["あらわ", "げん"], "混": ["ま", "こ", "こん"],
            "採": ["と", "さい"], "授": ["さず", "じゅ"], "術": ["じゅつ"],
            "常": ["つね", "とこ", "じょう"], "情": ["なさ", "じょう", "せい"],
            "責": ["せ", "せき"], "接": ["つ", "せつ"], "設": ["もう", "せつ"],
            "率": ["ひき", "りつ", "そつ"], "断": ["た", "ことわ", "だん"],
            "張": ["は", "ちょう"], "停": ["てい"], "堂": ["どう"],
            "得": ["え", "う", "とく"], "貧": ["まず", "ひん", "びん"],
            "婦": ["ふ"], "務": ["つと", "む"], "略": ["りゃく"],
            "営": ["いとな", "えい"], "過": ["す", "あやま", "か"],
            "喜": ["よろこ", "き"], "検": ["けん"], "減": ["へ", "げん"],
            "証": ["あか", "しょう"], "象": ["ぞう", "しょう"], "税": ["ぜい"],
            "絶": ["た", "ぜつ"], "測": ["はか", "そく"], "属": ["ぞく"],
            "貸": ["か", "たい"], "貯": ["ちょ"], "提": ["さ", "てい"],
            "程": ["ほど", "てい"], "統": ["す", "とう"], "費": ["つい", "ひ"],
            "備": ["そな", "び"], "評": ["ひょう"], "復": ["ふく"],
            "報": ["むく", "ほう"], "貿": ["ぼう"], "解": ["と", "げ", "かい"],
            "幹": ["みき", "かん"], "義": ["ぎ"], "禁": ["きん"],
            "鉱": ["こう"], "罪": ["つみ", "ざい"], "資": ["し"],
            "飼": ["か", "し"], "準": ["じゅん"], "勢": ["いきお", "せい"],
            "損": ["そこ", "そん"], "墓": ["はか", "ぼ"], "豊": ["ゆた", "ほう", "ぶ"],
            "夢": ["ゆめ", "む"], "演": ["えん"], "慣": ["な", "かん"],
            "境": ["さかい", "きょう", "けい"], "構": ["かま", "こう"],
            "際": ["きわ", "さい"], "雑": ["ざつ", "ぞう"], "酸": ["す", "さん"],
            "精": ["せい", "しょう"], "製": ["せい"], "総": ["そう"],
            "像": ["ぞう"], "増": ["ま", "ふ", "ぞう"], "態": ["たい"],
            "適": ["てき"], "銅": ["どう"], "複": ["ふく"],
            "綿": ["わた", "めん"], "領": ["りょう"], "歴": ["れき"],
            "確": ["たし", "かく"], "潔": ["いさぎよ", "けつ"], "賛": ["さん"],
            "質": ["たち", "しつ", "しち", "ち"], "賞": ["しょう"],
            "導": ["みちび", "どう"], "編": ["あ", "へん"], "暴": ["あば", "ぼう"],
            "衛": ["えい"], "興": ["おこ", "きょう", "こう"], "築": ["きず", "ちく"],
            "燃": ["も", "ねん"], "輸": ["ゆ", "しゅ"], "講": ["こう"],
            "謝": ["あやま", "しゃ"], "績": ["せき"], "額": ["ひたい", "がく"],
            "織": ["お", "しょく", "しき"], "職": ["しょく"], "識": ["し", "しき"],
            "護": ["まも", "ご"],
            // Grade 6 (191 kanji)
            "干": ["ほ", "かん"], "己": ["おのれ", "こ", "き"], "寸": ["すん"],
            "亡": ["な", "ぼう", "もう"], "尺": ["しゃく"], "収": ["おさ", "しゅう"],
            "仁": ["じん", "に", "にん"], "片": ["かた", "へん"], "穴": ["あな", "けつ"],
            "冊": ["さつ", "さく"], "処": ["しょ"], "庁": ["ちょう"],
            "幼": ["おさな", "よう"], "宇": ["う"], "灰": ["はい", "かい"],
            "危": ["あぶ", "あや", "き"], "机": ["つくえ", "き"], "吸": ["す", "きゅう"],
            "后": ["きさき", "こう", "ご"], "至": ["いた", "し"], "舌": ["した", "ぜつ"],
            "存": ["そん", "ぞん"], "宅": ["たく"], "我": ["われ", "わ", "が"],
            "系": ["けい"], "孝": ["こう"], "困": ["こま", "こん"],
            "私": ["わたし", "わたくし", "し"], "否": ["いな", "ひ"], "批": ["ひ"],
            "忘": ["わす", "ぼう"], "乱": ["みだ", "らん"], "卵": ["たまご", "らん"],
            "延": ["の", "えん"], "沿": ["そ", "えん"], "拡": ["ひろ", "かく"],
            "供": ["そな", "とも", "きょう", "く"], "券": ["けん"],
            "呼": ["よ", "こ"], "刻": ["きざ", "こく"], "若": ["わか", "も", "じゃく", "にゃく"],
            "宗": ["むね", "しゅう", "そう"], "承": ["うけたまわ", "しょう"],
            "垂": ["た", "すい"], "担": ["かつ", "にな", "たん"], "宙": ["ちゅう"],
            "忠": ["ちゅう"], "届": ["とど"], "乳": ["ちち", "にゅう"],
            "拝": ["おが", "はい"], "並": ["なら", "なみ", "へい", "びょう"],
            "宝": ["たから", "ほう"], "枚": ["まい"], "胃": ["い"],
            "映": ["うつ", "は", "えい"], "革": ["かわ", "かく"], "巻": ["ま", "まき", "かん", "けん"],
            "看": ["かん"], "皇": ["こう", "おう"], "紅": ["べに", "くれない", "こう", "く"],
            "砂": ["すな", "さ", "しゃ"], "姿": ["すがた", "し"], "宣": ["せん"],
            "専": ["もっぱ", "せん"], "泉": ["いずみ", "せん"], "洗": ["あら", "せん"],
            "染": ["そ", "し", "せん"], "奏": ["かな", "そう"], "退": ["しりぞ", "たい"],
            "段": ["だん"], "派": ["は"], "背": ["せ", "そむ", "はい"],
            "肺": ["はい"], "律": ["りつ", "りち"], "恩": ["おん"],
            "株": ["かぶ"], "胸": ["むね", "きょう"], "降": ["お", "ふ", "こう"],
            "骨": ["ほね", "こつ"], "座": ["すわ", "ざ"], "蚕": ["かいこ", "さん"],
            "射": ["い", "しゃ"], "従": ["したが", "じゅう", "しょう"],
            "純": ["じゅん"], "除": ["のぞ", "じょ", "じ"], "将": ["しょう"],
            "針": ["はり", "しん"], "値": ["ね", "あたい", "ち"], "展": ["てん"],
            "討": ["う", "とう"], "党": ["とう"], "納": ["おさ", "の", "のう", "な", "なん", "とう"],
            "俳": ["はい"], "班": ["はん"], "秘": ["ひ", "ひめ"],
            "俵": ["たわら", "ひょう"], "陛": ["へい"], "朗": ["ほが", "ろう"],
            "異": ["こと", "い"], "域": ["いき"], "郷": ["さと", "きょう", "ごう"],
            "済": ["す", "さい", "せい"], "視": ["し"], "捨": ["す", "しゃ"],
            "推": ["お", "すい"], "盛": ["も", "さか", "せい", "じょう"],
            "窓": ["まど", "そう"], "探": ["さぐ", "さが", "たん"], "著": ["あらわ", "ちょ", "ちゃく"],
            "頂": ["いただ", "ちょう"], "脳": ["のう"], "閉": ["と", "し", "へい"],
            "訪": ["おとず", "たず", "ほう"], "密": ["みつ"], "訳": ["わけ", "やく"],
            "郵": ["ゆう"], "欲": ["ほ", "よく"], "翌": ["よく"],
            "割": ["わ", "さ", "かつ"], "揮": ["き"], "貴": ["たっと", "とうと", "き"],
            "勤": ["つと", "きん", "ごん"], "筋": ["すじ", "きん"], "敬": ["うやま", "けい"],
            "裁": ["た", "さば", "さい"], "策": ["さく"], "詞": ["し"],
            "就": ["つ", "しゅう", "じゅ"], "衆": ["しゅう", "しゅ"], "善": ["よ", "ぜん"],
            "創": ["つく", "そう"], "装": ["よそお", "そう", "しょう"], "尊": ["たっと", "とうと", "そん"],
            "痛": ["いた", "つう"], "晩": ["ばん"], "補": ["おぎな", "ほ"],
            "棒": ["ぼう"], "絹": ["きぬ", "けん"], "源": ["みなもと", "げん"],
            "署": ["しょ"], "傷": ["きず", "いた", "しょう"], "蒸": ["む", "じょう"],
            "聖": ["せい", "しょう"], "誠": ["まこと", "せい"], "暖": ["あたた", "だん"],
            "腸": ["ちょう"], "賃": ["ちん"], "腹": ["はら", "ふく"],
            "幕": ["まく", "ばく"], "盟": ["めい"], "預": ["あず", "よ"],
            "裏": ["うら", "り"], "閣": ["かく"], "疑": ["うたが", "ぎ"],
            "誤": ["あやま", "ご"], "穀": ["こく"], "誌": ["し"],
            "磁": ["じ"], "障": ["さわ", "しょう"], "銭": ["ぜに", "せん"],
            "層": ["そう"], "認": ["みと", "にん"], "暮": ["く", "ぼ"],
            "模": ["も", "ぼ"], "遺": ["のこ", "い", "ゆい"], "劇": ["げき"],
            "権": ["けん", "ごん"], "熟": ["じゅく"], "諸": ["しょ"],
            "蔵": ["くら", "ぞう"], "誕": ["たん"], "潮": ["しお", "ちょう"],
            "敵": ["かたき", "てき"], "論": ["ろん"], "激": ["はげ", "げき"],
            "憲": ["けん"], "鋼": ["はがね", "こう"], "樹": ["き", "じゅ"],
            "縦": ["たて", "じゅう"], "操": ["みさお", "あやつ", "そう"], "糖": ["とう"],
            "奮": ["ふる", "ふん"], "厳": ["おごそ", "きび", "ごん", "げん"],
            "縮": ["ちぢ", "しゅく"], "優": ["やさ", "すぐ", "ゆう"], "覧": ["らん"],
            "簡": ["かん"], "難": ["むずか", "かた", "なん"], "臨": ["のぞ", "りん"],
            "警": ["けい"], "臓": ["ぞう"]
        };

        // Get all unique readings for distractors (from vocab + kanji readings)
        function getAllReadings() {
            const vocabReadings = VOCABULARY.map(v => v.reading);
            const kanjiReadings = Object.values(KANJI_READINGS).flat();
            return [...new Set([...vocabReadings, ...kanjiReadings])];
        }

        // Get available vocab (words where all kanji are learned)
        function getAvailableVocab() {
            return VOCABULARY.filter(v => v.kanji.every(k => learnedKanji.has(k)));
        }

        // Get kanji that are learned but have no vocab coverage
        function getKanjiWithoutVocab() {
            const vocabKanji = new Set();
            VOCABULARY.forEach(v => v.kanji.forEach(k => vocabKanji.add(k)));
            return [...learnedKanji].filter(k => !vocabKanji.has(k) && KANJI_READINGS[k]);
        }

        // Create reading cards for ALL learned kanji - ONE CARD PER READING
        function getReadingCards() {
            const cards = [];

            // Create cards for ALL learned kanji, not just those without vocab
            [...learnedKanji].forEach(k => {
                const readings = KANJI_READINGS[k] || [];
                readings.forEach((reading, index) => {
                    cards.push({
                        word: k,
                        reading: reading,
                        meaning: `Reading ${index + 1} of ${readings.length}: ${reading}`,
                        kanji: [k],
                        isReadingCard: true,
                        allReadings: readings,
                        readingIndex: index,
                        srsKey: `reading:${k}:${reading}` // Unique key per reading
                    });
                });
            });

            return cards;
        }

        // Compute deck coverage
        function computeDeckCoverage() {
            const vocabKanji = new Set();
            VOCABULARY.forEach(v => v.kanji.forEach(k => vocabKanji.add(k)));

            const allKanji = [];
            for (let g = 1; g <= 6; g++) allKanji.push(...KANJI_BY_GRADE[g]);

            const covered = allKanji.filter(k => vocabKanji.has(k) || KANJI_READINGS[k]);
            const learnedCovered = [...learnedKanji].filter(k => vocabKanji.has(k) || KANJI_READINGS[k]);

            return {
                totalKanji: allKanji.length,
                vocabCovered: allKanji.filter(k => vocabKanji.has(k)).length,
                readingsCovered: Object.keys(KANJI_READINGS).length,
                learnedWithReview: learnedCovered.length
            };
        }

        // SRS Algorithm (simplified SM-2)
        function getSRSKey(item) {
            // Use srsKey if defined (per-reading cards), otherwise fallback
            if (item.srsKey) return item.srsKey;
            return item.isReadingCard ? `reading:${item.word}` : item.word;
        }

        function getSRSInterval(item) {
            const key = getSRSKey(item);
            const data = srsData[key] || { level: 0, nextReview: 0, easeFactor: 2.5 };
            return data;
        }

        function updateSRS(item, correct) {
            const now = Date.now();
            const key = getSRSKey(item);
            const data = srsData[key] || { level: 0, nextReview: 0, easeFactor: 2.5 };

            if (correct) {
                data.level = Math.min(data.level + 1, 8);
                // Intervals: 1min, 10min, 1hr, 8hr, 1day, 3day, 1week, 2weeks, 1month
                const intervals = [60000, 600000, 3600000, 28800000, 86400000, 259200000, 604800000, 1209600000, 2592000000];
                data.nextReview = now + intervals[Math.min(data.level, intervals.length - 1)];
                data.easeFactor = Math.min(data.easeFactor + 0.1, 3.0);
            } else {
                data.level = Math.max(0, data.level - 2);
                data.nextReview = now + 60000; // Review again in 1 min
                data.easeFactor = Math.max(1.3, data.easeFactor - 0.2);
            }

            srsData[key] = data;
            localStorage.setItem('srsData', JSON.stringify(srsData));
        }

        // Get items due for review (vocab + reading cards)
        function getDueReviews() {
            const now = Date.now();

            // Get available vocabulary
            const availableVocab = getAvailableVocab();

            // Get reading cards for kanji without vocab
            const readingCards = getReadingCards();

            // Combine both
            const allItems = [...availableVocab, ...readingCards];

            // Items due for review (past their nextReview time)
            const due = allItems.filter(item => {
                const key = getSRSKey(item);
                const data = srsData[key];
                if (!data) return true; // New items are due
                return data.nextReview <= now;
            });

            // Sort: new items first, then by nextReview time
            due.sort((a, b) => {
                const aData = srsData[getSRSKey(a)];
                const bData = srsData[getSRSKey(b)];
                if (!aData && bData) return -1;
                if (aData && !bData) return 1;
                if (!aData && !bData) return 0;
                return aData.nextReview - bData.nextReview;
            });

            return due;
        }

        function init() {
            checkStreak();
            renderGradeSections();
            updateStats();
            renderHistory();
            updateReviewButton();
        }

        function checkStreak() {
            if (!streakData.lastPractice) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const lastPractice = new Date(streakData.lastPractice);
            lastPractice.setHours(0, 0, 0, 0);

            const daysDiff = Math.floor((today - lastPractice) / (1000 * 60 * 60 * 24));

            if (daysDiff > 1) {
                // Streak broken
                streakData.streak = 0;
                saveStreak();
            }
        }

        function updateStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!streakData.lastPractice) {
                // First practice ever
                streakData.streak = 1;
                streakData.lastPractice = today.toISOString();
            } else {
                const lastPractice = new Date(streakData.lastPractice);
                lastPractice.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((today - lastPractice) / (1000 * 60 * 60 * 24));

                if (daysDiff === 1) {
                    // Consecutive day - increment streak
                    streakData.streak++;
                    streakData.lastPractice = today.toISOString();
                } else if (daysDiff === 0) {
                    // Same day - keep streak, update timestamp
                    streakData.lastPractice = today.toISOString();
                } else {
                    // Streak broken, start fresh
                    streakData.streak = 1;
                    streakData.lastPractice = today.toISOString();
                }
            }
            saveStreak();
        }

        function saveStreak() {
            localStorage.setItem('streakData', JSON.stringify(streakData));
        }

        function renderGradeSections() {
            const container = document.getElementById('grade-sections');
            container.innerHTML = '';

            for (let grade = 1; grade <= 6; grade++) {
                const kanji = KANJI_BY_GRADE[grade];
                const learnedInGrade = [...kanji].filter(k => learnedKanji.has(k)).length;
                const isExpanded = expandedGrades.has(grade);

                const section = document.createElement('div');
                section.className = `grade-section ${isExpanded ? 'expanded' : ''}`;
                section.innerHTML = `
                    <div class="grade-header" onclick="toggleGrade(${grade})">
                        <span class="grade-title">
                            ${GRADE_NAMES[grade]}
                            <span class="grade-progress">
                                <span class="learned-count">${learnedInGrade}</span> / ${kanji.length}
                            </span>
                        </span>
                        <span class="grade-arrow">▼</span>
                    </div>
                    <div class="grade-content">
                        <div class="kanji-grid" id="grid-${grade}"></div>
                    </div>
                `;
                container.appendChild(section);

                if (isExpanded) {
                    renderKanjiGrid(grade);
                }
            }
        }

        function toggleGrade(grade) {
            if (expandedGrades.has(grade)) {
                expandedGrades.delete(grade);
            } else {
                expandedGrades.add(grade);
            }
            renderGradeSections();
        }

        function renderKanjiGrid(grade) {
            const container = document.getElementById(`grid-${grade}`);
            if (!container) return;

            const kanji = KANJI_BY_GRADE[grade];
            container.innerHTML = '';

            for (const char of kanji) {
                const div = document.createElement('div');
                div.className = 'kanji-char';
                div.textContent = char;

                if (learnedKanji.has(char)) {
                    div.classList.add('learned');
                }

                div.onclick = () => handleKanjiClick(char, div);
                container.appendChild(div);
            }
        }

        function handleKanjiClick(char, element) {
            // Always open practice modal - practice required to mark as learned
            openPracticeModal(char);
        }

        // Practice Modal
        function openPracticeModal(char) {
            currentPracticeChar = char;
            strokeDataLoaded = false;

            const modal = document.getElementById('practice-modal');
            const target = document.getElementById('writer-target');

            document.getElementById('modal-target').textContent = char;
            document.getElementById('modal-status').textContent = '';
            document.getElementById('modal-status').className = 'modal-status';

            // Reset action buttons visibility
            document.getElementById('modal-actions-main').style.display = 'flex';
            document.getElementById('modal-actions-fallback').style.display = 'none';

            // Lock body scroll on mobile
            document.body.classList.add('modal-open');

            modal.classList.add('active');
            target.innerHTML = '';

            // Dynamic canvas size based on container (responsive)
            const containerStyle = getComputedStyle(target);
            const canvasSize = Math.min(
                parseInt(containerStyle.width) || 280,
                parseInt(containerStyle.height) || 280
            );
            const isMobile = window.innerWidth <= 600;

            // Create HanziWriter with Japanese data preference
            writer = HanziWriter.create('writer-target', char, {
                width: canvasSize,
                height: canvasSize,
                padding: 20,
                showOutline: true,
                strokeAnimationSpeed: 1.5,
                delayBetweenStrokes: 150,
                strokeColor: '#1a1a1a',
                radicalColor: '#d73b3e',
                highlightColor: '#c9a227',
                outlineColor: '#e8e4dc',
                drawingColor: '#1a1a1a',
                leniency: isMobile ? 1.5 : 1.2, // More forgiving on mobile
                showHintAfterMisses: isMobile ? 2 : 3, // Faster hints on mobile
                charDataLoader: function(char, onComplete, onErr) {
                    // Try multiple data sources for maximum kanji coverage
                    // 1. hanzi-writer-data-ja (AnimCJK based, best for Japanese)
                    // 2. @jamsch/hanzi-writer-data-jp
                    // 3. Default hanzi-writer-data (Chinese)
                    const sources = [
                        `https://raw.githubusercontent.com/mnako/hanzi-writer-data-ja/master/data/${char}.json`,
                        `https://cdn.jsdelivr.net/npm/@jamsch/hanzi-writer-data-jp@2.0.2/${char}.json`,
                        `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`
                    ];

                    function trySource(index) {
                        if (index >= sources.length) {
                            strokeDataLoaded = false;
                            showDataUnavailable();
                            if (onErr) onErr(new Error('No stroke data found'));
                            return;
                        }

                        fetch(sources[index])
                            .then(res => {
                                if (!res.ok) throw new Error('Data not found');
                                return res.json();
                            })
                            .then(data => {
                                strokeDataLoaded = true;
                                onComplete(data);
                            })
                            .catch(() => {
                                trySource(index + 1);
                            });
                    }

                    trySource(0);
                }
            });

            // Start quiz mode
            startQuiz();
        }

        function startQuiz() {
            if (!writer) return;

            writer.quiz({
                onMistake: function(strokeData) {
                    document.getElementById('modal-status').textContent =
                        `Stroke ${strokeData.strokeNum + 1}: Try again`;
                    document.getElementById('modal-status').className = 'modal-status error';
                },
                onCorrectStroke: function(strokeData) {
                    document.getElementById('modal-status').textContent = '';
                },
                onComplete: function(summaryData) {
                    // Success!
                    document.getElementById('modal-status').textContent = 'Mastered!';
                    document.getElementById('modal-status').className = 'modal-status success';

                    // Auto-mark as learned after brief delay
                    setTimeout(() => {
                        markAsLearned(currentPracticeChar);
                        closeModal();
                    }, 800);
                }
            });
        }

        function showAnimation() {
            if (writer) {
                writer.cancelQuiz();
                writer.animateCharacter({
                    onComplete: () => {
                        setTimeout(startQuiz, 500);
                    }
                });
            }
        }

        function retryQuiz() {
            if (writer) {
                writer.cancelQuiz();
                document.getElementById('modal-status').textContent = '';
                document.getElementById('modal-status').className = 'modal-status';
                startQuiz();
            }
        }

        function skipKanji() {
            closeModal();
        }

        function showDataUnavailable() {
            // Show fallback UI when stroke data can't be loaded
            document.getElementById('modal-actions-main').style.display = 'none';
            document.getElementById('modal-actions-fallback').style.display = 'flex';
            document.getElementById('modal-status').textContent =
                'Stroke data unavailable — network error or unsupported kanji';
            document.getElementById('modal-status').className = 'modal-status error';
        }

        function markLearnedAnyway() {
            // Fallback: mark as learned without practice (only when data unavailable)
            if (currentPracticeChar) {
                markAsLearned(currentPracticeChar, 'fallback');
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('practice-modal').classList.remove('active');
            document.body.classList.remove('modal-open'); // Restore body scroll
            if (writer) {
                writer.cancelQuiz();
                writer = null;
            }
            currentPracticeChar = null;
        }

        function markAsLearned(char, method = 'practice') {
            if (learnedKanji.has(char)) return;

            learnedKanji.add(char);

            const entry = {
                id: Date.now(),
                date: new Date().toISOString(),
                kanji: char,
                count: 1,
                method: method // 'practice' or 'fallback'
            };
            history.unshift(entry);

            updateStreak(); // Track daily practice
            save();
            renderGradeSections();
            updateStats();
            renderHistory();
            updateReviewButton(); // New vocab may be available
        }

        function save() {
            localStorage.setItem('learnedKanji', JSON.stringify([...learnedKanji]));
            localStorage.setItem('kanjiHistory', JSON.stringify(history));
        }

        function updateStats() {
            const learned = learnedKanji.size;
            const remaining = TOTAL_KANJI - learned;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysLeft = Math.max(0, Math.ceil((TARGET_DATE - today) / (1000 * 60 * 60 * 24)));
            const perDay = daysLeft > 0 ? Math.ceil(remaining / daysLeft) : 0;
            const percent = (learned / TOTAL_KANJI) * 100;

            document.getElementById('learned-count').textContent = learned;
            document.getElementById('remaining-count').textContent = remaining;
            document.getElementById('days-left').textContent = daysLeft;
            document.getElementById('per-day').textContent = perDay;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('streak-count').textContent = streakData.streak;
        }

        function renderHistory() {
            const container = document.getElementById('history-list');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="kanji">始</div>
                        <p>Click kanji above to begin</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.slice(0, 10).map(entry => {
                const date = new Date(entry.date);
                const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const icon = entry.method === 'practice' ? '✍' : (entry.method === 'fallback' ? '⚠' : '');
                return `
                    <div class="history-item">
                        <span class="history-kanji">${icon}${entry.kanji}</span>
                        <div class="history-meta">
                            <div class="history-count">+${entry.count}</div>
                            <div>${formatted}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportData() {
            const data = {
                learnedKanji: [...learnedKanji],
                history: history,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanji-journey-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Share Modal Functions
        const SHARE_URL = 'https://robjohncolson.github.io/kanji/';

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            document.body.classList.add('modal-open');
            modal.classList.add('active');

            // Generate QR code using qrcode-generator library
            const container = document.getElementById('qr-container');
            try {
                const qr = qrcode(0, 'M');
                qr.addData(SHARE_URL);
                qr.make();

                // Create image from QR code
                container.innerHTML = qr.createImgTag(5, 10);
                // Style the generated image
                const img = container.querySelector('img');
                if (img) {
                    img.style.display = 'block';
                }
            } catch (err) {
                console.error('QR generation failed:', err);
                container.innerHTML = '<div style="padding: 2rem; color: #666;">QR unavailable</div>';
            }

            // Show native share button if supported
            if (navigator.share) {
                document.getElementById('native-share-container').style.display = 'flex';
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('copy-feedback').textContent = '';
        }

        function copyShareUrl() {
            const input = document.getElementById('share-url-input');
            navigator.clipboard.writeText(input.value).then(() => {
                document.getElementById('copy-feedback').textContent = 'Link copied!';
                setTimeout(() => {
                    document.getElementById('copy-feedback').textContent = '';
                }, 2000);
            });
        }

        async function nativeShare() {
            try {
                await navigator.share({
                    title: '漢字の道 — Kanji Journey',
                    text: `I'm learning ${learnedKanji.size} of 1,026 kanji before my Japan trip! Try this practice app:`,
                    url: SHARE_URL
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    copyShareUrl(); // Fallback to copy
                }
            }
        }

        // Review Session Functions
        function updateReviewButton() {
            const due = getDueReviews();
            const btn = document.getElementById('review-btn');
            const count = document.getElementById('review-count');

            count.textContent = due.length;
            btn.disabled = due.length === 0;

            // Update coverage tooltip
            const coverage = computeDeckCoverage();
            const vocabCards = getAvailableVocab().length;
            const readingCards = getReadingCards().length;
            btn.title = `${vocabCards} vocab cards + ${readingCards} reading cards\nCoverage: ${coverage.readingsCovered}/1026 kanji have readings`;
        }

        function startReviewSession() {
            const due = getDueReviews();
            if (due.length === 0) return;

            // Take up to 10 items for this session
            reviewSession.queue = due.slice(0, 10);
            reviewSession.current = null;
            reviewSession.correct = 0;
            reviewSession.wrong = 0;

            document.getElementById('review-correct').textContent = '0';
            document.getElementById('review-wrong').textContent = '0';

            const modal = document.getElementById('review-modal');
            document.body.classList.add('modal-open');
            modal.classList.add('active');

            nextReviewCard();
        }

        function nextReviewCard() {
            const feedback = document.getElementById('review-feedback');
            feedback.className = 'review-feedback';
            feedback.innerHTML = '';

            document.getElementById('review-next-btn').style.display = 'none';

            if (reviewSession.queue.length === 0) {
                // Session complete
                showSessionComplete();
                return;
            }

            reviewSession.current = reviewSession.queue.shift();
            displayReviewCard(reviewSession.current);
        }

        function displayReviewCard(item) {
            document.getElementById('review-word').textContent = item.word;

            // Update prompt based on card type
            const prompt = document.getElementById('review-prompt');
            if (item.isReadingCard) {
                const readingNum = item.readingIndex !== undefined ? item.readingIndex + 1 : 1;
                const totalReadings = item.allReadings ? item.allReadings.length : 1;
                prompt.textContent = `Reading ${readingNum} of ${totalReadings} — Which is it?`;
            } else {
                prompt.textContent = 'How do you read this word?';
            }

            // Generate choices: correct answer + 3 distractors
            const allReadings = getAllReadings();
            const distractors = allReadings
                .filter(r => r !== item.reading)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const choices = [item.reading, ...distractors].sort(() => Math.random() - 0.5);

            const container = document.getElementById('reading-choices');
            container.innerHTML = choices.map(reading => `
                <button class="reading-choice" onclick="checkAnswer('${reading}')">${reading}</button>
            `).join('');
        }

        function checkAnswer(selected) {
            const item = reviewSession.current;
            const correct = selected === item.reading;

            // Update SRS
            updateSRS(item, correct);

            // Update session stats
            if (correct) {
                reviewSession.correct++;
                document.getElementById('review-correct').textContent = reviewSession.correct;
            } else {
                reviewSession.wrong++;
                document.getElementById('review-wrong').textContent = reviewSession.wrong;
                // Add back to queue for retry
                reviewSession.queue.push(item);
            }

            // Mark buttons
            const buttons = document.querySelectorAll('.reading-choice');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === item.reading) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selected && !correct) {
                    btn.classList.add('incorrect');
                }
            });

            // Show feedback with furigana exposition for reading cards
            const feedback = document.getElementById('review-feedback');
            let exposition = '';

            if (item.isReadingCard && item.allReadings) {
                const readingsList = item.allReadings.map((r, i) =>
                    `<span class="${r === item.reading ? 'current-reading' : ''}">${r}</span>`
                ).join(' ・ ');
                exposition = `<div class="all-readings">All readings: ${readingsList}</div>`;
            }

            if (correct) {
                feedback.className = 'review-feedback correct';
                feedback.innerHTML = `<div>Correct!</div>${exposition}<div class="meaning">${item.meaning}</div>`;
            } else {
                feedback.className = 'review-feedback incorrect';
                feedback.innerHTML = `<div>The answer is: ${item.reading}</div>${exposition}<div class="meaning">${item.meaning}</div>`;
            }

            // Show next button
            document.getElementById('review-next-btn').style.display = 'inline-block';
        }

        function showSessionComplete() {
            document.getElementById('review-word').textContent = '完了!';
            document.getElementById('reading-choices').innerHTML = '';

            const feedback = document.getElementById('review-feedback');
            const total = reviewSession.correct + reviewSession.wrong;
            const accuracy = total > 0 ? Math.round((reviewSession.correct / total) * 100) : 0;

            feedback.className = 'review-feedback correct';
            feedback.innerHTML = `
                <div style="font-size: 1.2rem;">Session Complete</div>
                <div class="meaning">${accuracy}% accuracy</div>
            `;

            document.getElementById('review-next-btn').style.display = 'none';
            updateReviewButton();
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.remove('active');
            document.body.classList.remove('modal-open');
            updateReviewButton();
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeShareModal();
                closeReviewModal();
            }
        });

        // Close modal on overlay click
        document.getElementById('practice-modal').addEventListener('click', (e) => {
            if (e.target.id === 'practice-modal') closeModal();
        });

        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.id === 'share-modal') closeShareModal();
        });

        document.getElementById('review-modal').addEventListener('click', (e) => {
            if (e.target.id === 'review-modal') closeReviewModal();
        });

        init();
    </script>
</body>
</html>
